<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="max-age=14400">
    <title>Asystent Kas Biletowych</title>
    <style>
        /* --- Zmienne CSS --- */
        :root {
            --primary: #0056b3;
            --bg: #f4f4f9;
            --white: #ffffff;
            --open: #28a745;
            --closed: #dc3545;
            --break: #ffc107;
            --holiday: #6f42c1;
            --note-bg: #fff3cd;
            --note-text: #856404;
            --old-data-bg: #f8d7da; /* T≈Ço dla starych danych (jasnoczerwone) */
            --old-data-text: #721c24; /* Tekst dla starych danych (ciemnoczerwony) */
            --text: #333;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --warning-bg: #fff3cd; 
            --warning-border: #ffeeba;
            --warning-text: #856404;
        }

        /* --- Globalne style i reset --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 15px; 
            padding-bottom: 60px; /* Miejsce na stopkƒô */
        }

        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            width: 100%;
        }
        
        h1 { 
            text-align: center; 
            color: var(--primary); 
            margin-bottom: 15px; 
            font-size: 1.6rem;
            letter-spacing: -0.5px;
        }

        /* --- Sekcja ostrzegawcza WA≈ªNE --- */
        .important-warning {
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            color: var(--warning-text);
        }
        .important-warning strong {
            display: block;
            font-size: 1.1rem;
            color: #721c24; /* Czerwony dla WA≈ªNE */
            margin-bottom: 5px;
        }

        /* --- Status sieci i Daty --- */
        .top-info-bar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .network-msg { 
            text-align: center; 
            font-size: 0.8rem; 
            font-weight: bold; 
        }
        .msg-online { color: var(--open); }
        .msg-offline { color: var(--closed); }
        .cache-status {
            font-size: 0.8rem;
            color: #555;
            text-align: center;
            font-style: italic;
            margin-top: -5px;
        }

        .date-bar {
            background: #e9ecef;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            color: #555;
            border: 1px solid #ddd;
            font-size: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            line-height: 1.4;
        }
        .time-display { color: var(--primary); font-weight: 800; margin-left: 10px; }
        .holiday-tag {
            background-color: var(--holiday);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-left: 6px;
            display: inline-block;
            white-space: nowrap;
        }

        /* --- Panel Sterowania --- */
        .controls {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }
        button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 15px;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:active { transform: scale(0.98); background-color: #004494; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; }
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            background-color: #fff;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }

        /* --- G≈Å√ìWNY BOX STATUSU --- */
        #mainStatusBox {
            display: none;
            text-align: center;
            padding: 25px 15px;
            border-radius: 12px;
            color: white;
            font-weight: 800;
            font-size: 2rem;
            text-transform: uppercase;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            line-height: 1.1;
        }
        .bg-open { background: linear-gradient(135deg, var(--open), #1e7e34); }
        .bg-break { background: linear-gradient(135deg, var(--break), #d39e00); color: #212529 !important; text-shadow: none !important; }
        .bg-closed { background: linear-gradient(135deg, var(--closed), #bd2130); }

        /* --- Kafelki Przewo≈∫nik√≥w --- */
        .details-container { display: none; }
        
        .card {
            background: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
            border-left: 6px solid #ccc;
        }
        .card-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
            gap: 10px;
        }
        .carrier-title { font-size: 1.1rem; font-weight: 700; color: #2c3e50; }
        .epa-info { font-size: 0.8rem; color: #7f8c8d; margin-top: 2px; }
        
        .status-pill {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 80px;
            text-align: center;
        }

        /* Sekcja Uwagi */
        .notes-section {
            background-color: var(--note-bg);
            color: var(--note-text);
            padding: 10px 15px;
            font-size: 0.9rem;
            border-top: 1px solid #ffeb8f;
            font-style: italic;
            font-weight: 600;
        }
        .notes-section strong { font-style: normal; font-weight: 700; margin-right: 5px; }

        /* Komunikat o starych danych */
        .data-age-warning {
            background-color: var(--old-data-bg);
            color: var(--old-data-text);
            padding: 8px 15px;
            font-size: 0.85rem;
            text-align: center;
            font-weight: 600;
            border-top: 1px solid #f5c6cb;
        }


        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f1f1f1;
            vertical-align: top;
        }
        th { color: #666; width: 35%; font-weight: normal; } 
        
        .active-row { background-color: #e8f5e9; color: #1b5e20; }
        .active-row th { color: #1b5e20; font-weight: 700; }
        .active-row td { font-weight: 600; }

        .btn-link {
            display: block;
            text-align: center;
            margin: 15px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            border: 2px solid #e9ecef;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            transition: 0.2s;
        }
        .btn-link:active { background-color: #e2e6ea; border-color: #dae0e5; }

        .meta-footer {
            font-size: 0.7rem;
            color: #95a5a6;
            text-align: right;
            padding: 8px 15px;
            background: #fff;
            border-top: 1px solid #f8f9fa;
        }
        
        /* --- STOPKA --- */
        .page-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--primary);
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-size: 0.8rem;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.15);
        }
        .page-footer a { color: #ccc; text-decoration: none; }
        .page-footer a:hover { color: var(--white); }


        @media (max-width: 370px) {
            h1 { font-size: 1.4rem; }
            #mainStatusBox { font-size: 1.6rem; padding: 20px 10px; }
            th { width: 30%; font-size: 0.85rem; }
            td { font-size: 0.85rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üöÜ Asystent Kas Biletowych</h1>
    
    <div class="important-warning">
        <strong><center>‚ö†Ô∏è WA≈ªNE: Strona jest wy≈ÇƒÖcznie NARZƒòDZIEM POGLƒÑDOWYM</center></strong><br>
       <center>W przypadku wƒÖtpliwo≈õci informacje nalezy weryfikowaƒá na stronach przewo≈∫nik√≥w.</center> 
    </div>

    <div class="top-info-bar">
        <div id="networkStatus" class="network-msg">≈Åadowanie systemu...</div>
        <div id="cacheStatus" class="cache-status"></div>
        <div id="dateBar" class="date-bar">...</div>
    </div>

    <div class="controls">
        <!-- <button onclick="pobierzDane(true)">Pobierz wykaz kas do pamiƒôci podrƒôcznej</button> -->
        <label for="stationSelect">Wybierz stacjƒô:</label>
        <select id="stationSelect" onchange="wyswietlStacje()">
            <option value="">-- Najpierw pobierz dane --</option>
        </select>
    </div>

    <div id="mainStatusBox">STATUS</div>

    <div id="detailsList" class="details-container"></div>
</div>

<footer class="page-footer">
    Autorzy: Piotr M. üöÇ (Dane & Wizja), Gemini (Kod & Implementacja)<br>
    Edytorzy danych: Piotr M. üöÇ Anna S. Piotr S.
</footer>

<script>
    // ================= KONFIGURACJA =================
    const URL_DANYCH = 'kasy.json'; 
    const STORAGE_KEY = 'kasy_biletowe_v_final';
    const MAX_DAYS_FRESH = 30; // Maksymalna liczba dni, po kt√≥rej dane sƒÖ uznawane za przestarza≈Çe
    let bazaDanych = [];

    // ================= BAZA LINK√ìW DO PRZEWO≈πNIK√ìW =================
    const BAZA_LINKOW = {
        "PKP INTERCITY": "https://www.intercity.pl/pl/site/dla-pasazera/kup-bilet/wyszukiwarka-kas-i-biletomatow.html",
        "POLREGIO": "https://polregio.pl/pl/dla-podroznych/gdzie-kupic-bilet/kasy-biletowe/",
        "ARRIVA RP": "https://arriva.pl/1032/kasy-biletowe",
        "KOLEJE ≈öLƒÑSKIE": "https://www.kolejeslaskie.com/kup_bilet/na-dworcu/",
        "K≈ö": "https://www.kolejeslaskie.com/kup_bilet/na-dworcu/",
        "KOLEJE MAZOWIECKIE": "https://www.mazowieckie.com.pl/pl/strefa-podroznych/wyszukiwarka-kas-biletomatow",
        "KM": "https://www.mazowieckie.com.pl/pl/strefa-podroznych/wyszukiwarka-kas-biletomatow",
        "≈Å√ìDZKA KOLEJ AGLOMERACYJNA": "https://lka.lodzkie.pl/kasy-biletowe/",
        "≈ÅKA": "https://lka.lodzkie.pl/kasy-biletowe/",
        "KOLEJE WIELKOPOLSKIE": "https://koleje-wielkopolskie.com.pl/dla-pasazera/kasy-biletowe/",
        "KW": "https://koleje-wielkopolskie.com.pl/dla-pasazera/kasy-biletowe/",
        "KOLEJE DOLNO≈öLƒÑSKIE": "https://kolejedolnoslaskie.pl/informacje-o-kanalach-sprzedazy/kasy-biletowe/",
        "KD": "https://kolejedolnoslaskie.pl/informacje-o-kanalach-sprzedazy/kasy-biletowe/",
        "KOLEJE MA≈ÅOPOLSKIE": "https://www.kolejemalopolskie.com.pl/pl/kasa-biletowa-kolei-malopolskich-na-dworcu-krakow-glowny",
        "SZYBKA KOLEJ MIEJSKA W TR√ìJMIE≈öCIE": "https://www.skm.pkp.pl/dla-pasazera/taryfy-i-przepisy/wykaz-kas-i-automatow",
        "PKP SKM": "https://www.skm.pkp.pl/dla-pasazera/taryfy-i-przepisy/wykaz-kas-i-automatow",
        "BRAK": null
    };

    // ================= KALENDARZ ≈öWIƒÑT =================
    const SWIETA_STALE = {
        '01-01': 'Nowy Rok', '01-06': 'Trzech Kr√≥li', '05-01': '≈öwiƒôto Pracy',
        '05-03': '3 Maja', '08-15': 'Wniebowziƒôcie NMP',
        '11-01': 'Wszystkich ≈öwiƒôtych', '11-11': 'Niepodleg≈Ço≈õci',
        '12-24': 'Wielkanoc', '12-25': 'Bo≈ºe Narodzenie', '12-26': 'Drugi dzie≈Ñ Bo≈ºego Narodzenia'
    };
const SWIETA_RUCHOME = {
        '2025-04-20': 'Wielkanoc', '2025-04-21': 'Pon. Wielkanocny', '2025-06-08': 'Zielone ≈öwiƒÖtki', '2025-06-19': 'Bo≈ºe Cia≈Ço',
        '2026-04-05': 'Wielkanoc', '2026-04-06': 'Pon. Wielkanocny', '2026-05-24': 'Zielone ≈öwiƒÖtki', '2026-06-04': 'Bo≈ºe Cia≈Ço',
        '2027-03-28': 'Wielkanoc', '2027-03-29': 'Pon. Wielkanocny', '2027-05-16': 'Zielone ≈öwiƒÖtki', '2027-05-27': 'Bo≈ºe Cia≈Ço',
        '2028-04-16': 'Wielkanoc', '2028-04-17': 'Pon. Wielkanocny', '2028-06-04': 'Zielone ≈öwiƒÖtki', '2028-06-15': 'Bo≈ºe Cia≈Ço',
        '2029-04-01': 'Wielkanoc', '2029-04-02': 'Pon. Wielkanocny', '2029-05-20': 'Zielone ≈öwiƒÖtki', '2029-05-31': 'Bo≈ºe Cia≈Ço',
        '2030-04-21': 'Wielkanoc', '2030-04-22': 'Pon. Wielkanocny', '2030-06-09': 'Zielone ≈öwiƒÖtki', '2030-06-20': 'Bo≈ºe Cia≈Ço',
        '2031-04-13': 'Wielkanoc', '2031-04-14': 'Pon. Wielkanocny', '2031-06-01': 'Zielone ≈öwiƒÖtki', '2031-06-12': 'Bo≈ºe Cia≈Ço',
        '2032-03-28': 'Wielkanoc', '2032-03-29': 'Pon. Wielkanocny', '2032-05-16': 'Zielone ≈öwiƒÖtki', '2032-05-27': 'Bo≈ºe Cia≈Ço',
        '2033-04-17': 'Wielkanoc', '2033-04-18': 'Pon. Wielkanocny', '2033-06-05': 'Zielone ≈öwiƒÖtki', '2033-06-16': 'Bo≈ºe Cia≈Ço',
        '2034-04-09': 'Wielkanoc', '2034-04-10': 'Pon. Wielkanocny', '2034-05-28': 'Zielone ≈öwiƒÖtki', '2034-06-08': 'Bo≈ºe Cia≈Ço',
        '2035-03-25': 'Wielkanoc', '2035-03-26': 'Pon. Wielkanocny', '2035-05-13': 'Zielone ≈öwiƒÖtki', '2035-05-24': 'Bo≈ºe Cia≈Ço',
        '2036-04-13': 'Wielkanoc', '2036-04-14': 'Pon. Wielkanocny', '2036-06-01': 'Zielone ≈öwiƒÖtki', '2036-06-12': 'Bo≈ºe Cia≈Ço',
        '2037-04-05': 'Wielkanoc', '2037-04-06': 'Pon. Wielkanocny', '2037-05-24': 'Zielone ≈öwiƒÖtki', '2037-06-04': 'Bo≈ºe Cia≈Ço',
        '2038-04-25': 'Wielkanoc', '2038-04-26': 'Pon. Wielkanocny', '2038-06-13': 'Zielone ≈öwiƒÖtki', '2038-06-24': 'Bo≈ºe Cia≈Ço',
        '2039-04-10': 'Wielkanoc', '2039-04-11': 'Pon. Wielkanocny', '2039-05-29': 'Zielone ≈öwiƒÖtki', '2039-06-09': 'Bo≈ºe Cia≈Ço',
        '2040-04-01': 'Wielkanoc', '2040-04-02': 'Pon. Wielkanocny', '2040-05-20': 'Zielone ≈öwiƒÖtki', '2040-05-31': 'Bo≈ºe Cia≈Ço',
        '2041-04-21': 'Wielkanoc', '2041-04-22': 'Pon. Wielkanocny', '2041-06-09': 'Zielone ≈öwiƒÖtki', '2041-06-20': 'Bo≈ºe Cia≈Ço',
        '2042-04-06': 'Wielkanoc', '2042-04-07': 'Pon. Wielkanocny', '2042-05-25': 'Zielone ≈öwiƒÖtki', '2042-06-05': 'Bo≈ºe Cia≈Ço',
        '2043-03-29': 'Wielkanoc', '2043-03-30': 'Pon. Wielkanocny', '2043-05-17': 'Zielone ≈öwiƒÖtki', '2043-05-28': 'Bo≈ºe Cia≈Ço',
        '2044-04-17': 'Wielkanoc', '2044-04-18': 'Pon. Wielkanocny', '2044-06-05': 'Zielone ≈öwiƒÖtki', '2044-06-16': 'Bo≈ºe Cia≈Ço',
        '2045-04-09': 'Wielkanoc', '2045-04-10': 'Pon. Wielkanocny', '2045-05-28': 'Zielone ≈öwiƒÖtki', '2045-06-08': 'Bo≈ºe Cia≈Ço',
        '2046-03-25': 'Wielkanoc', '2046-03-26': 'Pon. Wielkanocny', '2046-05-13': 'Zielone ≈öwiƒÖtki', '2046-05-24': 'Bo≈ºe Cia≈Ço',
        '2047-04-14': 'Wielkanoc', '2047-04-15': 'Pon. Wielkanocny', '2047-06-02': 'Zielone ≈öwiƒÖtki', '2047-06-13': 'Bo≈ºe Cia≈Ço',
        '2048-04-05': 'Wielkanoc', '2048-04-06': 'Pon. Wielkanocny', '2048-05-24': 'Zielone ≈öwiƒÖtki', '2048-06-04': 'Bo≈ºe Cia≈Ço',
        '2049-04-18': 'Wielkanoc', '2049-04-19': 'Pon. Wielkanocny', '2049-06-06': 'Zielone ≈öwiƒÖtki', '2049-06-17': 'Bo≈ºe Cia≈Ço',
        '2050-04-10': 'Wielkanoc', '2050-04-11': 'Pon. Wielkanocny', '2050-05-29': 'Zielone ≈öwiƒÖtki', '2050-06-09': 'Bo≈ºe Cia≈Ço'
    };

    function sprawdzSwieto() {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        const keyFixed = `${m}-${day}`;
        const keyMoveable = `${y}-${m}-${day}`;
        if(SWIETA_STALE[keyFixed]) return SWIETA_STALE[keyFixed];
        if(SWIETA_RUCHOME[keyMoveable]) return SWIETA_RUCHOME[keyMoveable];
        return null;
    }

    // ================= FUNKCJA WERYFIKACJI WIEKU DANYCH =================
    function checkDataAge(dataDateStr) {
        if (!dataDateStr) return false;

        // U≈ºywamy formatu YYYY-MM-DD
        const dataDate = new Date(dataDateStr);
        const today = new Date();

        // Ustawienie obu dat na p√≥≈Çnoc, aby uniknƒÖƒá problem√≥w z r√≥≈ºnicami czasowymi
        dataDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);

        const diffTime = Math.abs(today - dataDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        return diffDays > MAX_DAYS_FRESH;
    }

    // ================= FUNKCJA TRANSFORMACJI DANYCH I OBS≈ÅUGI CACHE =================
    
    // Funkcja do transformacji p≈Çaskich danych JSON z kropkami na zagnie≈ºd≈ºone obiekty
    function transformData(data) {
        if (!Array.isArray(data)) return data;

        return data.map(item => {
            const newItem = {};
            const itemKeys = Object.keys(item);

            itemKeys.forEach(key => {
                const value = item[key];
                const parts = key.split('.');
                let current = newItem;

                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (i === parts.length - 1) {
                        current[part] = value;
                    } else {
                        if (!current[part] || typeof current[part] !== 'object') {
                            current[part] = {};
                        }
                        current = current[part];
                    }
                }
            });

            // Standaryzacja kluczowych p√≥l i obs≈Çuga pustych/nan
            newItem.przewoznik = String(newItem.przewoznik || 'BRAK').toUpperCase();
            newItem.epa = newItem.epa || 'Brak';
            newItem.uwagi = (newItem.uwagi && String(newItem.uwagi).toLowerCase() !== 'nan') ? newItem.uwagi : '';
            if (newItem.meta && newItem.meta.data) {
                newItem.meta.data = String(newItem.meta.data);
            }
            return newItem;
        });
    }

    // Funkcja do aktualizacji statusu cache w UI
    function updateCacheStatus() {
        const cacheStatusElement = document.getElementById('cacheStatus');
        const cacheTime = localStorage.getItem(STORAGE_KEY + '_time');

        if (cacheTime) {
            const date = new Date(parseInt(cacheTime));
            const dateStr = date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', year: 'numeric' });
            const timeStr = date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
            cacheStatusElement.innerHTML = `Baza w pamiƒôci przeglƒÖdarki z: ${dateStr}, ${timeStr}`;
        } else {
            cacheStatusElement.innerHTML = `Brak danych w pamiƒôci. Uruchom ponownie przeglƒÖdarkƒô i sprawd≈∫ czy dostƒôp do internetu jest aktywny. <br><br> WYSTƒÑPI≈Å B≈ÅƒÑD PO≈ÅƒÑCZENIA Z SERWEREM`;
        }
    }


    // ================= LOGIKA DANYCH (OFFLINE) =================
    async function pobierzDane(force = false) {
        const netMsg = document.getElementById('networkStatus');
        netMsg.innerText = "≈ÅƒÖczenie z serwerem...";

        try {
            const res = await fetch(URL_DANYCH, { cache: "no-store" });
            if(!res.ok) throw new Error("B≈ÇƒÖd HTTP");
            const json = await res.json();
            
            const processedData = transformData(json);
            const now = Date.now();
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(processedData));
            localStorage.setItem(STORAGE_KEY + '_time', now.toString()); // Zapis czasu pobrania
            bazaDanych = processedData;
            
            netMsg.innerHTML = "<span class='msg-online'>‚úÖ Dane pobrane pomy≈õlnie!</span>";
            if(force) alert("Dane zaktualizowane pomy≈õlnie!");
            zbudujSelect();
            updateCacheStatus();

        } catch (e) {
            console.warn("Offline fallback:", e);
            const cached = localStorage.getItem(STORAGE_KEY);
            if(cached) {
                bazaDanych = JSON.parse(cached);
                bazaDanych = transformData(bazaDanych); 
                netMsg.innerHTML = "<span class='msg-offline'>‚ö†Ô∏è Tryb Offline (B≈ÇƒÖd sieci)</span>";
                if(force) alert("Brak sieci. Wczytano dane z pamiƒôci urzƒÖdzenia.");
                zbudujSelect();
            } else {
                netMsg.innerHTML = "<span class='msg-offline'>‚ùå Brak danych i b≈ÇƒÖd sieci</span>";
            }
            updateCacheStatus();
        }
    }

    // ================= INTERFEJS I ZEGAR =================
    function initZegar() {
        const d = new Date();
        const optionsDate = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        let dateStr = d.toLocaleDateString('pl-PL', optionsDate);
        dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
        const timeStr = d.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const swieto = sprawdzSwieto();
        const bar = document.getElementById('dateBar');
        
        let htmlContent = `${dateStr} <span class="time-display">‚è∞ ${timeStr}</span>`;
        if(swieto) {
            htmlContent += ` <span class="holiday-tag">‚òÖ ${swieto}</span>`;
            bar.style.borderColor = "var(--holiday)";
        } else {
            bar.style.borderColor = "#ddd";
        }
        bar.innerHTML = htmlContent;
    }

    function zbudujSelect() {
        const sel = document.getElementById('stationSelect');
        const saved = sel.value;
        sel.innerHTML = '<option value="">-- Wybierz stacjƒô --</option>';

        const stacje = [...new Set(bazaDanych.map(x => x.stacja))].sort((a,b) => a.localeCompare(b));
        stacje.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.text = s;
            sel.appendChild(opt);
        });

        if(saved && stacje.includes(saved)) {
            sel.value = saved;
            wyswietlStacje();
        }
    }

    function wyswietlStacje() {
        const nazwa = document.getElementById('stationSelect').value;
        const mainBox = document.getElementById('mainStatusBox');
        const listContainer = document.getElementById('detailsList');
        
        listContainer.innerHTML = '';
        if(!nazwa) {
            mainBox.style.display = 'none';
            listContainer.style.display = 'none';
            return;
        }

        const kasy = bazaDanych.filter(k => k.stacja === nazwa);
        
        let anyOpen = false;
        let anyBreak = false;

        const d = new Date();
        const swieto = sprawdzSwieto();
        const day = d.getDay(); 
        let dayType = 'pn_pt';
        if(swieto || day === 0) dayType = 'nd';
        else if(day === 6) dayType = 'sob';

        kasy.forEach(k => {
            const st = obliczStatus(k, swieto, day);
            if(st.type === 'open') anyOpen = true;
            if(st.type === 'break') anyBreak = true;
            
            const isDataOld = checkDataAge(k.meta.data);
            const linkPrzewoznika = BAZA_LINKOW[k.przewoznik] || null;

            const uwagiHtml = (k.uwagi && String(k.uwagi).toLowerCase() !== 'nan') ? 
                `<div class="notes-section"><strong>UWAGI:</strong> ${k.uwagi}</div>` : '';
            
            const dataAgeWarningHtml = isDataOld ? 
                `<div class="data-age-warning">‚õî Dane nieaktualne (starsze ni≈º ${MAX_DAYS_FRESH} dni). Weryfikuj u przewo≈∫nika!</div>` : '';

            const html = `
            <div class="card" style="border-left-color: ${st.color}">
                <div class="card-header">
                    <div>
                        <div class="carrier-title">${k.przewoznik}</div>
                        <div class="epa-info">EPA: ${k.epa || 'Brak danych'}</div>
                    </div>
                    <div class="status-pill" style="background-color: ${st.color}; color: ${st.type==='break'?'#333':'white'}">
                        ${st.text}
                    </div>
                </div>
                
                ${dataAgeWarningHtml}
                ${uwagiHtml}

                <table>
                    <tr class="${dayType==='pn_pt'?'active-row':''}">
                        <th>Pn - Pt</th>
                        <td>${k.godziny.pn_pt} <br> <small style="color:#777">Przerwa: ${k.przerwy.pn_pt||'-'}</small></td>
                    </tr>
                    <tr class="${dayType==='sob'?'active-row':''}">
                        <th>Sobota</th>
                        <td>${k.godziny.sob} <br> <small style="color:#777">Przerwa: ${k.przerwy.sob||'-'}</small></td>
                    </tr>
                    <tr class="${dayType==='nd'?'active-row':''}">
                        <th>Ndz / ≈öw</th>
                        <td>${k.godziny.nd} <br> <small style="color:#777">Przerwa: ${k.przerwy.nd||'-'}</small></td>
                    </tr>
                </table>
                
                ${linkPrzewoznika ? `<a href="${linkPrzewoznika}" target="_blank" class="btn-link">Wykaz kas: ${k.przewoznik} &raquo;</a>` : ''}

                <div class="meta-footer">Data danych: ${k.meta.data} | Autor: ${k.meta.kto}</div>
            </div>`;
            listContainer.innerHTML += html;
        });

        mainBox.style.display = 'block';
        mainBox.className = ''; 
        if(anyOpen) {
            mainBox.innerText = "KASA CZYNNA";
            mainBox.classList.add('bg-open');
        } else if(anyBreak) {
            mainBox.innerText = "PRZERWA";
            mainBox.classList.add('bg-break');
        } else {
            mainBox.innerText = "NIECZYNNE";
            mainBox.classList.add('bg-closed');
        }
        listContainer.style.display = 'block';
    }

    // ================= KALKULATOR (OSTATECZNA POPRAWKA CZASU) =================
    function obliczStatus(kasa, swieto, dayOfWeek) {
        let hStr, bStr;
        if(swieto || dayOfWeek === 0) {
            hStr = kasa.godziny.nd;
            bStr = kasa.przerwy.nd;
        } else if(dayOfWeek === 6) {
            hStr = kasa.godziny.sob;
            bStr = kasa.przerwy.sob;
        } else {
            hStr = kasa.godziny.pn_pt;
            bStr = kasa.przerwy.pn_pt;
        }

        const hStrLower = String(hStr).toLowerCase();
        const is24h = hStrLower.includes('ca≈Çodobowo');
        
        if(!hStr || hStrLower.includes('nieczynne') || hStrLower.includes('zamkniƒôte')) {
            return { type: 'closed', text: 'ZAMKNIƒòTA', color: '#dc3545' };
        }

        const now = new Date();
        const min = now.getHours() * 60 + now.getMinutes();
        
        // Sprawdzanie, czy kasa jest otwarta (tylko je≈õli nie jest ca≈Çodobowa)
        if (!is24h) {
            const [open, close] = parseRange(hStr);
            let isOpen = false;
            
            if (open <= close) {
                if(min >= open && min < close) isOpen = true;
            } else {
                if(min >= open || min < close) isOpen = true; // Przej≈õcie przez p√≥≈Çnoc
            }

            if(!isOpen) return { type: 'closed', text: 'ZAMKNIƒòTA', color: '#dc3545' };
        }
        
        // Sprawdzenie przerwy (dla wszystkich, w tym ca≈Çodobowych)
        const bStrLower = String(bStr).toLowerCase();
        if(bStr && bStrLower.length > 3 && !bStrLower.includes('brak') && bStrLower !== 'nan') {
            const breaks = String(bStr).split(';');
            for(let br of breaks) {
                const [bStart, bEnd] = parseRange(br.trim());
                
                let isDuringBreak = false;
                if (bStart <= bEnd) {
                    if (min >= bStart && min < bEnd) isDuringBreak = true;
                } else {
                    if (min >= bStart || min < bEnd) isDuringBreak = true; // Przerwa przechodzƒÖca przez p√≥≈Çnoc
                }

                if(isDuringBreak) {
                    return { type: 'break', text: 'PRZERWA', color: '#ffc107' };
                }
            }
        }

        return { type: 'open', text: 'OTWARTA', color: '#28a745' };
    }

    function parseTime(t) {
        if(!t) return 0;
        const [h, m] = String(t).split(':').map(Number);
        return h * 60 + m;
    }
    
    function parseRange(str) {
        if(!str || !String(str).includes('-')) return [0,0];
        const parts = String(str).split('-');
        return [parseTime(parts[0]), parseTime(parts[1])];
    }

    window.onload = () => {
        initZegar();
        pobierzDane();
        updateCacheStatus(); 
        setInterval(() => { initZegar(); }, 1000);
        setInterval(() => { wyswietlStacje(); }, 60000);
    };

    
</script>

       <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-W05T4L1HFD');
</script>

</body>
</html>