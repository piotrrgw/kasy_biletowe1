<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asystent Kas Biletowych v4.2</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-W05T4L1HFD');
    </script>

    <style>
        /* --- USTAWIENIA KOLOR√ìW (VARIABLES) --- */
        :root {
            --open: #218838;       /* Ciemniejszy zielony */
            --break: #ffc107;      /* ≈ª√≥≈Çty */
            --closed: #c82333;     /* Ciemniejszy czerwony */
            --none: #6c757d;       /* Szary */
            --holiday: #0056b3;    /* Ciemniejszy niebieski */
            --bg-light: #f8f9fa;
            --bg-dark: #343a40;
            --text-dark: #212529;
            --text-light: #f8f9fa;
            --border-color: #dee2e6;
            --focus-ring: 0 0 0 3px rgba(0, 123, 255, 0.5);
        }

        /* Tryb Wysokiego Kontrastu (Dark Mode) */
        body.high-contrast {
            --bg-light: #121212;
            --bg-dark: #000000;
            --text-dark: #ffffff;
            --text-light: #ffff00;
            --border-color: #555;
            --holiday: #3399ff;
        }
        
        body.high-contrast .card, 
        body.high-contrast .station-tile {
            background-color: #1e1e1e !important;
            color: #fff !important;
            border: 1px solid #555;
        }

        body.high-contrast input {
            background-color: #333;
            color: #fff;
            border-color: #777;
        }

        /* --- PODSTAWOWY STYL --- */
        html { font-size: 100%; box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            font-size: 1rem;
            line-height: 1.5;
            display: flex; flex-direction: column;
            min-height: 100vh;
        }

        /* --- NAG≈Å√ìWEK --- */
        header {
            background-color: var(--bg-dark);
            color: var(--text-light);
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1000;
        }

        header h1 { margin: 0; font-size: 1.4rem; }

        /* --- PRZYCISK USTAWIE≈É --- */
        .settings-btn {
            position: absolute; right: 15px; top: 50%;
            transform: translateY(-50%);
            background: transparent; border: 1px solid rgba(255,255,255,0.4);
            border-radius: 8px; color: var(--text-light);
            font-size: 1.5rem; cursor: pointer;
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .settings-btn:focus { outline: none; box-shadow: 0 0 0 2px #fff; }

        /* --- MENU --- */
        .settings-menu {
            position: fixed; top: 70px; right: 10px; left: 10px; 
            max-width: 450px; margin-left: auto; 
            background-color: white; color: #333;
            border: 1px solid #ccc; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); 
            z-index: 1100; display: none;
            border-radius: 12px; overflow: hidden; 
            max-height: 85vh; overflow-y: auto; 
        }

        .settings-menu.active { display: block; }

        .menu-item {
            display: flex; align-items: center; width: 100%;
            padding: 15px; text-align: left;
            border: none; background: white; cursor: pointer;
            border-bottom: 1px solid #eee; font-size: 1rem; color: #333;
        }

        .menu-item:hover { background-color: #f8f9fa; }
        .menu-item .icon { margin-right: 15px; font-size: 1.2rem; }

        /* --- HISTORIA WYSZUKIWANIA --- */
        #historyContainer { margin-bottom: 20px; display: none; }
        .history-label { font-size: 0.85rem; color: var(--none); margin-bottom: 5px; display: block; }
        .history-chips { display: flex; gap: 8px; flex-wrap: wrap; }
        .chip {
            background-color: #e9ecef; border: 1px solid #ced4da;
            border-radius: 16px; padding: 6px 12px; font-size: 0.9rem;
            cursor: pointer; transition: background 0.2s;
        }
        .chip:hover { background-color: #dee2e6; }

        /* --- G≈Å√ìWNA ZAWARTO≈öƒÜ --- */
        .container {
            flex: 1; max-width: 800px; margin: 0 auto;
            padding: 20px 15px; width: 100%;
        }

        /* --- PASEK DATY --- */
        #dateBar {
            background-color: white; padding: 15px; margin-bottom: 20px;
            border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 1.1rem; text-align: center;
            border-left: 6px solid var(--border-color); color: #333;
        }

        body.high-contrast #dateBar { background-color: #222; color: #fff; }

        .holiday-tag {
            background-color: var(--holiday); color: white;
            padding: 3px 8px; border-radius: 4px;
            font-weight: bold; font-size: 0.9rem;
            display: inline-block; margin-top: 5px;
        }

        /* --- WYSZUKIWARKA --- */
        #searchContainer { position: relative; margin-bottom: 15px; }

        #stationSearch {
            width: 100%; padding: 14px; font-size: 1.1rem; 
            border: 2px solid #ccc; border-radius: 8px;
            outline: none; -webkit-appearance: none;
        }

        #stationSearch:focus { border-color: var(--holiday); box-shadow: var(--focus-ring); }

        #searchResults {
            position: absolute; top: 100%; left: 0; right: 0;
            background-color: white; border: 2px solid var(--holiday);
            border-top: none; list-style: none; padding: 0; margin: 0;
            max-height: 50vh; overflow-y: auto; z-index: 50;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border-radius: 0 0 8px 8px; display: none;
        }

        .search-result-item {
            padding: 12px 15px; cursor: pointer;
            border-bottom: 1px solid #eee; font-size: 1.1rem; color: #333;
        }

        .search-result-item.selected, .search-result-item:hover {
            background-color: #e2e6ea; font-weight: bold;
        }

        /* --- STATUS GL√ìWNY --- */
        #mainStatusBox {
            padding: 1.5rem; color: white; text-align: center;
            font-size: 1.8rem; font-weight: bold;
            border-radius: 12px; margin-bottom: 25px;
            display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        #mainStatusBox.bg-open { background-color: var(--open); }
        #mainStatusBox.bg-break { background-color: var(--break); color: #212529; }
        #mainStatusBox.bg-closed { background-color: var(--closed); }
        #mainStatusBox.bg-none { background-color: var(--none); }

        /* --- KARTY SZCZEG√ì≈Å√ìW --- */
        #detailsList { display: grid; gap: 20px; }

        .card {
            background-color: white; padding: 1.5rem;
            border-radius: 12px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-left: 8px solid #ccc; position: relative;
        }

        .card-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 1rem; padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        body.high-contrast .card-header { border-bottom-color: #444; }

        .carrier-title { font-weight: bold; font-size: 1.2rem; }
        .epa-info { font-size: 0.9rem; color: var(--none); }

        .status-pill {
            padding: 0.4rem 0.8rem; border-radius: 6px;
            font-weight: bold; font-size: 0.9rem; text-transform: uppercase;
        }

        /* --- TABELA --- */
        .details-table { width: 100%; border-collapse: collapse; font-size: 1rem; }
        .details-table th, .details-table td {
            padding: 8px 5px; text-align: left; vertical-align: top;
            border-bottom: 1px solid #eee;
        }
        
        body.high-contrast .details-table th, 
        body.high-contrast .details-table td { border-bottom-color: #444; }

        .details-table .active-row { background-color: #eef2f5; font-weight: bold; }
        
        body.high-contrast .details-table .active-row {
            background-color: #333; color: #fff;
        }
        
        .notes-section {
            background-color: #fff3cd; color: #856404; padding: 10px;
            border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #ffeeba;
        }
        
        /* Styl kafelek w widoku wszystkich stacji */
        .station-tile {
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
            font-size: 1.05rem; transition: transform 0.1s;
        }
        .station-tile:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
        .station-status-icon {
            font-size: 0.8rem; font-weight: bold; 
            padding: 3px 8px; border-radius: 12px; color: #fff;
        }

        /* --- STOPKA --- */
        footer {
            text-align: center; padding: 20px; font-size: 0.85rem;
            color: var(--none); background-color: #f1f1f1;
            border-top: 1px solid #ddd;
        }
        
        body.high-contrast footer {
            background-color: #111; color: #888; border-top-color: #333;
        }

        /* MODAL POMOCY */
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); 
            justify-content: center; align-items: center;
        }

        .modal-content {
            background-color: white; padding: 25px;
            width: 90%; max-width: 600px;
            border-radius: 12px; color: #333;
        }

        .close-btn { float: right; font-size: 1.5rem; cursor: pointer; padding: 0 10px; }

        /* SKR√ìTY DOSTƒòPNO≈öCI W MENU */
        .text-size-control {
            background-color: #f8f9fa; padding: 15px;
            border-bottom: 1px solid #eee; text-align: center;
        }
        
        .size-btn {
            background: var(--holiday); color: white; border: none;
            padding: 5px 15px; border-radius: 4px;
            font-size: 1.1rem; cursor: pointer; margin: 0 5px;
        }
        
        #fileInput { display: none; }

    </style>
</head>
<body>

    <header role="banner">
        <h1>System Kas Biletowych</h1>
        <button class="settings-btn" onclick="toggleMenu()" aria-label="Ustawienia i Menu">‚öôÔ∏è</button>
        
        <div class="settings-menu" id="settingsMenu" role="dialog" aria-modal="true" aria-label="Menu Ustawie≈Ñ">
            
            <div class="text-size-control">
                <span style="display:block; margin-bottom:10px; font-weight:bold;">WyglƒÖd:</span>
                <button class="size-btn" onclick="toggleContrast()" aria-label="Prze≈ÇƒÖcz kontrast">üåì Kontrast</button>
                <div style="margin-top:10px;">
                    <span style="font-size:0.9rem;">Rozmiar tekstu:</span>
                    <button class="size-btn" onclick="zmienRozmiarTekstu(-1)">A-</button>
                    <button class="size-btn" onclick="zmienRozmiarTekstu(0)">A</button>
                    <button class="size-btn" onclick="zmienRozmiarTekstu(1)">A+</button>
                </div>
            </div>

            <button class="menu-item" onclick="pobierzDane(true)">
                <span class="icon">üîÑ</span> Wymu≈õ aktualizacjƒô (Online)
            </button>
            <button class="menu-item" onclick="pokazWszystkieStacje()">
                <span class="icon">üìã</span> Poka≈º wszystkie stacje
            </button>
            <button class="menu-item" onclick="document.getElementById('fileInput').click()">
                <span class="icon">üìÅ</span> Wgraj bazƒô (JSON)
            </button>
            <input type="file" id="fileInput" onchange="wgrajLokalnyPlik(this)" accept=".json">
            <button class="menu-item" onclick="pokazInstrukcje()">
                <span class="icon">‚ùì</span> Instrukcja / Oznaczenia
            </button>
            
            <div style="padding:10px; text-align:center; font-size:0.8rem; color:#666; background:#f0f0f0;">
                <span id="cacheStatus">Status bazy: ...</span>
            </div>
        </div>
    </header>

    <main class="container" role="main">
        <div id="dateBar" aria-live="polite"></div>

        <div id="searchContainer">
            <input type="text" id="stationSearch" 
                   placeholder="Wpisz nazwƒô stacji (np. Warszawa Centralna)..." 
                   aria-label="Wyszukaj stacjƒô"
                   autocomplete="off">
            <ul id="searchResults" role="listbox"></ul>
        </div>
        
        <div id="historyContainer">
            <span class="history-label">Ostatnio oglƒÖdane:</span>
            <div class="history-chips" id="historyChips"></div>
        </div>

        <div id="statusMessage" style="text-align:center; margin-bottom:10px;">
            <div id="networkStatus" style="font-size:0.9rem; color:#555;">≈Åadowanie systemu...</div>
        </div>

        <div id="mainStatusBox" role="status" aria-live="assertive"></div>

        <div id="detailsList"></div>
        
        <div style="margin-top: 30px; font-size: 0.8rem; text-align: center; color: #777;">
            Wci≈õnij <strong>ESC</strong> by wyczy≈õciƒá. U≈ºyj <strong>Strza≈Çek</strong> w wyszukiwarce.
        </div>
    </main>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="zamknijInstrukcje()">&times;</span>
            <h2>Oznaczenia</h2>
            <ul style="list-style:none; padding:0; line-height:2;">
                <li>üü¢ <strong>OTWARTA</strong> - kasa pracuje</li>
                <li>üü° <strong>PRZERWA</strong> - przerwa w pracy</li>
                <li>üî¥ <strong>ZAMKNIƒòTA</strong> - poza godzinami</li>
                <li>‚ö™ <strong>BRAK KASY</strong> - brak punktu sprzeda≈ºy</li>
            </ul>
            <hr>
            <p><strong>Wersja 4.2</strong>: Naprawiono brakujƒÖce linki do stron przewo≈∫nik√≥w (Arriva, Koleje Ma≈Çopolskie).</p>
        </div>
    </div>

    <footer>
        <p>Wersja aplikacji: <strong>v4.2</strong></p>
        <p>Wsp√≥≈Çautorzy: Gemini oraz Piotr M üöÇ</p>
    </footer>

<script>
    // ================= KONFIGURACJA =================
    const STORAGE_KEY = 'kasy_biletowe_v_final';
    const HISTORY_KEY = 'kasy_search_history';
    const SETTINGS_KEY = 'kasy_settings_v4';
    
    // Lista plik√≥w ≈∫r√≥d≈Çowych
    const PLIKI_DANYCH = [
        'data_pkp_intercity.json', 'data_polregio.json', 'data_arriva_rp.json',
        'data_koleje_slaskie.json', 'data_koleje_mazowieckie.json', 'data_lka.json',
        'data_koleje_wielkopolskie.json', 'data_koleje_dolnoslaskie.json', 
        'data_koleje_malopolskie.json', 'data_skm.json', 'data_brak_kasy.json'
    ];

    // NAPRAWIONY S≈ÅOWNIK LINK√ìW
    const BAZA_LINKOW = {
        "PKP INTERCITY": "https://www.intercity.pl/pl/site/dla-pasazera/kup-bilet/wyszukiwarka-kas-i-biletomatow.html",
        "POLREGIO": "https://polregio.pl/pl/dla-podroznych/gdzie-kupic-bilet/kasy-biletowe/",
        "KOLEJE ≈öLƒÑSKIE": "https://www.kolejeslaskie.com/kup_bilet/na-dworcu/",
        "KOLEJE MAZOWIECKIE": "https://www.mazowieckie.com.pl/pl/strefa-podroznych/wyszukiwarka-kas-biletomatow",
        "≈ÅKA": "https://lka.lodzkie.pl/kasy-biletowe/",
        "≈Å√ìDZKA KOLEJ AGLOMERACYJNA": "https://lka.lodzkie.pl/kasy-biletowe/",
        "KOLEJE WIELKOPOLSKIE": "https://koleje-wielkopolskie.com.pl/dla-pasazera/kasy-biletowe/",
        "KOLEJE DOLNO≈öLƒÑSKIE": "https://kolejedolnoslaskie.pl/informacje-o-kanalach-sprzedazy/kasy-biletowe/",
        "PKP SKM": "https://www.skm.pkp.pl/dla-pasazera/taryfy-i-przepisy/wykaz-kas-i-biletomatow",
        "SKM": "https://www.skm.pkp.pl/dla-pasazera/taryfy-i-przepisy/wykaz-kas-i-biletomatow",
        "KOLEJE MA≈ÅOPOLSKIE": "https://kolejemalopolskie.com.pl/pl/dla-pasazera/gdzie-kupic-bilet/kasy-biletowe",
        "ARRIVA RP": "https://arriva.pl/art/punkty-sprzedazy-biletow"
    };

    const SWIETA_STALE = {
        '01-01': 'Nowy Rok', '01-06': 'Trzech Kr√≥li', '05-01': '≈öwiƒôto Pracy',
        '05-03': '3 Maja', '08-15': 'Wniebowziƒôcie NMP', '11-01': 'Wszystkich ≈öwiƒôtych',
        '11-11': 'Niepodleg≈Ço≈õci', '12-24': 'Wigilia', '12-25': 'Bo≈ºe Narodzenie', '12-26': 'Drugi dzie≈Ñ ≈öw.'
    };

    let bazaDanych = [];
    let currentFocus = -1; 
    let userSettings = { fontSize: 100, highContrast: false };

    // ================= INICJALIZACJA =================
    window.onload = () => {
        loadSettings();
        initZegar();
        loadHistory();
        
        const cached = localStorage.getItem(STORAGE_KEY);
        if(cached) {
            try {
                bazaDanych = JSON.parse(cached);
                document.getElementById('networkStatus').innerHTML = "Gotowy (tryb offline)";
                updateCacheInfo();
            } catch(e) { console.error("Cache corrupted"); }
        }
        
        pobierzDane();

        setInterval(initZegar, 1000);
        setInterval(() => {
            if(document.getElementById('stationSearch').value) wyswietlStacje();
        }, 60000);

        setupSearchEvents();
    };

    // ================= OBS≈ÅUGA UI I USTAWIENIE≈É =================
    function loadSettings() {
        const saved = localStorage.getItem(SETTINGS_KEY);
        if(saved) userSettings = JSON.parse(saved);
        applySettings();
    }

    function saveSettings() {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(userSettings));
        applySettings();
    }

    function applySettings() {
        document.documentElement.style.fontSize = userSettings.fontSize + "%";
        if(userSettings.highContrast) document.body.classList.add('high-contrast');
        else document.body.classList.remove('high-contrast');
    }

    function toggleContrast() {
        userSettings.highContrast = !userSettings.highContrast;
        saveSettings();
    }

    function zmienRozmiarTekstu(delta) {
        if(delta === 0) userSettings.fontSize = 100;
        else userSettings.fontSize += (delta * 10);
        if(userSettings.fontSize < 80) userSettings.fontSize = 80;
        if(userSettings.fontSize > 150) userSettings.fontSize = 150;
        saveSettings();
    }

    function toggleMenu() {
        document.getElementById('settingsMenu').classList.toggle('active');
    }

    // ================= HISTORIA I SZUKANIE =================
    function loadHistory() {
        const raw = localStorage.getItem(HISTORY_KEY);
        const history = raw ? JSON.parse(raw) : [];
        const container = document.getElementById('historyChips');
        const wrapper = document.getElementById('historyContainer');
        container.innerHTML = '';
        if(history.length === 0) { wrapper.style.display = 'none'; return; }
        wrapper.style.display = 'block';
        history.forEach(stacja => {
            const btn = document.createElement('button');
            btn.className = 'chip';
            btn.innerText = stacja;
            btn.onclick = () => {
                document.getElementById('stationSearch').value = stacja;
                wyswietlStacje(stacja);
            };
            container.appendChild(btn);
        });
    }

    function addToHistory(stacja) {
        let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        history = history.filter(h => h !== stacja);
        history.unshift(stacja);
        if(history.length > 5) history.pop();
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        loadHistory();
    }

    function setupSearchEvents() {
        const input = document.getElementById('stationSearch');
        input.addEventListener('input', function() { filtrujStacje(this.value); });
        input.addEventListener('keydown', function(e) {
            const list = document.getElementById('searchResults');
            let items = list.getElementsByTagName('li');
            if (e.key === 'ArrowDown') { currentFocus++; addActive(items); }
            else if (e.key === 'ArrowUp') { currentFocus--; addActive(items); }
            else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentFocus > -1 && items[currentFocus]) items[currentFocus].click();
                else if (items.length > 0) items[0].click();
            } else if (e.key === 'Escape') {
                input.value = ''; list.style.display = 'none';
                document.getElementById('detailsList').innerHTML = '';
                document.getElementById('mainStatusBox').style.display = 'none';
                input.blur();
            }
        });
    }

    function addActive(items) {
        if (!items) return false;
        removeActive(items);
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (items.length - 1);
        items[currentFocus].classList.add("selected");
        items[currentFocus].scrollIntoView({block: "nearest"});
    }
    
    function removeActive(items) {
        for (let i = 0; i < items.length; i++) items[i].classList.remove("selected");
    }

    function normalizeText(text) {
        return String(text || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }

    function filtrujStacje(query) {
        const list = document.getElementById('searchResults');
        list.innerHTML = ''; currentFocus = -1;
        if (!query || query.length < 2) { list.style.display = 'none'; return; }

        const normalizedQuery = normalizeText(query);
        const seen = new Set();
        const results = [];

        bazaDanych.forEach(item => {
            if(item.ukryty) return;
            const nazwa = item.stacja;
            if(seen.has(nazwa)) return;
            if (normalizeText(nazwa).includes(normalizedQuery) || normalizeText(item.epa).includes(normalizedQuery)) {
                seen.add(nazwa);
                results.push(item);
            }
        });

        results.sort((a,b) => {
            const aS = normalizeText(a.stacja).startsWith(normalizedQuery);
            const bS = normalizeText(b.stacja).startsWith(normalizedQuery);
            if(aS && !bS) return -1; if(!aS && bS) return 1;
            return a.stacja.localeCompare(b.stacja);
        });

        if (results.length === 0) { list.style.display = 'none'; return; }

        results.slice(0, 15).forEach(item => {
            const li = document.createElement('li');
            li.className = 'search-result-item';
            li.role = "option";
            const epaTxt = (item.epa && item.epa !== 'Brak') ? ` <small style="color:#888">(${item.epa})</small>` : '';
            li.innerHTML = `${item.stacja}${epaTxt}`;
            li.onclick = () => { wybierzStacje(item.stacja); };
            list.appendChild(li);
        });
        list.style.display = 'block';
    }

    function wybierzStacje(stacja) {
        document.getElementById('stationSearch').value = stacja;
        document.getElementById('searchResults').style.display = 'none';
        wyswietlStacje(stacja);
        addToHistory(stacja);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ================= LOGIKA BIZNESOWA =================
    
    function wyswietlStacje(nazwaInput = null) {
        const nazwa = nazwaInput || document.getElementById('stationSearch').value;
        const container = document.getElementById('detailsList');
        const mainBox = document.getElementById('mainStatusBox');
        
        container.innerHTML = '';
        mainBox.style.display = 'none';

        const kasy = bazaDanych.filter(k => k.stacja === nazwa && !k.ukryty);
        if(kasy.length === 0) return;

        const d = new Date();
        const swieto = sprawdzSwieto();
        const day = d.getDay();
        let dayType = 'pn_pt';
        if(swieto || day === 0) dayType = 'nd';
        else if(day === 6) dayType = 'sob';

        let globalStatus = { code: 'closed', priority: 0 }; 

        kasy.forEach(k => {
            const status = obliczStatus(k, swieto, day);
            let currentPrio = 0;
            if (status.type === 'break') currentPrio = 1;
            if (status.type === 'open') currentPrio = 2;
            
            if (currentPrio > globalStatus.priority) {
                globalStatus = { code: status.type, priority: currentPrio };
            }
            if (k.przewoznik === 'BRAK') globalStatus.isNone = true;

            const link = BAZA_LINKOW[k.przewoznik] || BAZA_LINKOW[k.przewoznik.split(' ')[0]] || null;
            
            let cardHtml = `
            <div class="card" style="border-left-color: ${status.color}">
                <div class="card-header">
                    <div>
                        <div class="carrier-title">${k.przewoznik}</div>
                        <div class="epa-info">EPA: ${k.epa || '-'}</div>
                    </div>
                    <div class="status-pill" style="background:${status.color}; color:${status.type==='break'?'#222':'#fff'}">
                        ${status.text}
                    </div>
                </div>`;

            if(k.uwagi && k.uwagi.length > 2 && k.uwagi.toLowerCase() !== 'nan') {
                cardHtml += `<div class="notes-section">‚ö†Ô∏è ${k.uwagi}</div>`;
            }

            cardHtml += `
                <table class="details-table">
                    <tr class="${dayType==='pn_pt'?'active-row':''}">
                        <th>Pn-Pt</th>
                        <td>${k['godziny.pn_pt'] || '-'} <br><small>Przerwa: ${k['przerwy.pn_pt']||'-'}</small></td>
                    </tr>
                    <tr class="${dayType==='sob'?'active-row':''}">
                        <th>Sob</th>
                        <td>${k['godziny.sob'] || '-'} <br><small>Przerwa: ${k['przerwy.sob']||'-'}</small></td>
                    </tr>
                    <tr class="${dayType==='nd'?'active-row':''}">
                        <th>Ndz/≈öw</th>
                        <td>${k['godziny.nd'] || '-'} <br><small>Przerwa: ${k['przerwy.nd']||'-'}</small></td>
                    </tr>
                </table>
                ${link ? `<div style="text-align:right; margin-top:10px;"><a href="${link}" target="_blank" style="color:var(--holiday); font-weight:bold; text-decoration:none;">Strona przewo≈∫nika &rarr;</a></div>` : ''}
            </div>`;
            container.insertAdjacentHTML('beforeend', cardHtml);
        });

        mainBox.style.display = 'block';
        mainBox.className = '';
        
        if (globalStatus.isNone && globalStatus.priority === 0) {
            mainBox.innerText = "BRAK KASY";
            mainBox.classList.add('bg-none');
        } else if (globalStatus.code === 'open') {
            mainBox.innerText = "KASA CZYNNA";
            mainBox.classList.add('bg-open');
        } else if (globalStatus.code === 'break') {
            mainBox.innerText = "PRZERWA";
            mainBox.classList.add('bg-break');
        } else {
            mainBox.innerText = "NIECZYNNE";
            mainBox.classList.add('bg-closed');
        }
    }

    function obliczStatus(kasa, swieto, dayOfWeek) {
        if(kasa.przewoznik === 'BRAK') return { type: 'none', text: 'BRAK KASY', color: '#6c757d' };
        let hStr, bStr;
        if(swieto || dayOfWeek === 0) { hStr = kasa['godziny.nd']; bStr = kasa['przerwy.nd']; }
        else if(dayOfWeek === 6) { hStr = kasa['godziny.sob']; bStr = kasa['przerwy.sob']; }
        else { hStr = kasa['godziny.pn_pt']; bStr = kasa['przerwy.pn_pt']; }

        const h = String(hStr||"").toLowerCase();
        if(!h || h.includes('nieczynne') || h.includes('zamkniƒôte')) return { type: 'closed', text: 'ZAMKNIƒòTA', color: '#c82333' };
        if(h.includes('ca≈Çodobowo')) {
            if(isDuringBreak(bStr)) return { type: 'break', text: 'PRZERWA', color: '#ffc107' };
            return { type: 'open', text: 'OTWARTA', color: '#218838' };
        }

        const now = new Date();
        const min = now.getHours() * 60 + now.getMinutes();
        const [open, close] = parseRange(hStr);

        let isOpen = false;
        if(open <= close) { if(min >= open && min < close) isOpen = true; }
        else { if(min >= open || min < close) isOpen = true; }

        if(!isOpen) return { type: 'closed', text: 'ZAMKNIƒòTA', color: '#c82333' };
        if(isDuringBreak(bStr)) return { type: 'break', text: 'PRZERWA', color: '#ffc107' };

        return { type: 'open', text: 'OTWARTA', color: '#218838' };
    }

    function isDuringBreak(bStr) {
        if(!bStr || bStr.length < 3 || String(bStr).toLowerCase().includes('brak')) return false;
        const now = new Date();
        const min = now.getHours() * 60 + now.getMinutes();
        const breaks = String(bStr).split(';');
        
        for(let br of breaks) {
            const [start, end] = parseRange(br.trim());
            if(start === 0 && end === 0) continue;
            if(start <= end) { if(min >= start && min < end) return true; } 
            else { if(min >= start || min < end) return true; }
        }
        return false;
    }

    function parseRange(str) {
        if(!str || !str.includes('-')) return [0,0];
        const parts = str.split('-');
        return [parseTime(parts[0]), parseTime(parts[1])];
    }
    
    function parseTime(t) {
        const clean = String(t).replace('.',':').trim();
        const [h, m] = clean.split(':').map(Number);
        if(isNaN(h)) return 0;
        return h * 60 + (m || 0);
    }

    // ================= DANE I SIEC =================
    async function pobierzDane(force = false) {
        const netMsg = document.getElementById('networkStatus');
        if(force) netMsg.innerText = "Aktualizujƒô dane...";
        try {
            const fetchPromises = PLIKI_DANYCH.map(url => fetch(url, {cache: "no-store"}).then(r => r.ok ? r.json() : []));
            const results = await Promise.all(fetchPromises);
            let merged = [];
            results.forEach(arr => { if(Array.isArray(arr)) merged = merged.concat(arr); });
            
            if(merged.length > 0) {
                bazaDanych = merged.filter(x => !x.ukryty);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(bazaDanych));
                localStorage.setItem(STORAGE_KEY + '_date', new Date().toISOString());
                netMsg.innerHTML = "<span style='color:green'>‚úÖ Dane online</span>";
                updateCacheInfo();
                if(force) { alert("Pobrano najnowsze dane!"); toggleMenu(); }
            }
        } catch(e) {
            console.warn("Offline fallback", e);
            if(!force) netMsg.innerHTML = "<span style='color:#d9534f'>‚ö†Ô∏è Tryb Offline</span>";
        }
    }

    function updateCacheInfo() {
        const date = localStorage.getItem(STORAGE_KEY + '_date');
        const count = bazaDanych.length;
        const info = date ? `Data bazy: ${date.substring(0,10)}` : 'Brak daty';
        document.getElementById('cacheStatus').innerText = `${info} | Rekord√≥w: ${count}`;
    }

    // ================= KALENDARZ =================
    function initZegar() {
        const d = new Date();
        const opts = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        let dateStr = d.toLocaleDateString('pl-PL', opts);
        dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
        const timeStr = d.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
        const swieto = sprawdzSwieto();
        let html = `<strong>${dateStr}</strong> | Godz. ${timeStr}`;
        if(swieto) html += `<br><span class="holiday-tag">‚òÖ ${swieto}</span>`;
        
        document.getElementById('dateBar').innerHTML = html;
        if(swieto) document.getElementById('dateBar').style.borderColor = "var(--holiday)";
    }
    
    function sprawdzSwieto() {
        const d = new Date();
        const key = String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        if(SWIETA_STALE[key]) return SWIETA_STALE[key];
        
        const year = d.getFullYear();
        const a=year%19, b=Math.floor(year/100), c=year%100, d_v=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), h=(19*a+b-d_v-g+15)%30, i=Math.floor(c/4), k=c%4, l=(32+2*e+2*i-h-k)%7, m=Math.floor((a+11*h+22*l)/451), p=(h+l-7*m+114)%31, month=Math.floor((h+l-7*m+114)/31);
        const easter = new Date(year, month-1, p+1);
        
        const check = (off) => {
            const t = new Date(easter.getTime()); t.setDate(t.getDate()+off);
            return d.getDate()===t.getDate() && d.getMonth()===t.getMonth();
        };

        if(check(0)) return 'Wielkanoc';
        if(check(1)) return 'Poniedzia≈Çek Wielkanocny';
        if(check(49)) return 'Zielone ≈öwiƒÖtki';
        if(check(60)) return 'Bo≈ºe Cia≈Ço';
        
        return null;
    }

    // Pozosta≈Çe funkcje pomocnicze UI
    function pokazInstrukcje() { document.getElementById('helpModal').style.display = 'flex'; toggleMenu(); }
    function zamknijInstrukcje() { document.getElementById('helpModal').style.display = 'none'; }
    function wgrajLokalnyPlik(input) {
        const r = new FileReader();
        r.onload = e => {
            try { 
                bazaDanych = JSON.parse(e.target.result); 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(bazaDanych));
                alert("Wgrano!"); toggleMenu(); 
            } catch(x) { alert("B≈ÇƒÖd pliku"); }
        };
        if(input.files[0]) r.readAsText(input.files[0]);
    }

    function pokazWszystkieStacje() {
        const list = document.getElementById('detailsList');
        list.innerHTML = '<h3 style="margin-bottom:15px; border-bottom:1px solid #ccc; padding-bottom:5px;">Wszystkie stacje (szybki podglƒÖd):</h3>';
        
        // Dane do kalkulacji statusu
        const d = new Date();
        const swieto = sprawdzSwieto();
        const day = d.getDay();
        
        const unikalne = [...new Set(bazaDanych.map(x=>x.stacja))].sort();
        
        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">';
        
        unikalne.forEach(s => {
            // Obliczamy status zbiorczy dla stacji 's'
            const kasy = bazaDanych.filter(k => k.stacja === s && !k.ukryty);
            let color = '#6c757d'; // Default szary
            let statusPrio = -1; // 0=closed, 1=break, 2=open
            
            kasy.forEach(k => {
                const stat = obliczStatus(k, swieto, day);
                let p = 0;
                if(stat.type === 'open') p = 2;
                else if(stat.type === 'break') p = 1;
                
                if(p > statusPrio) {
                    statusPrio = p;
                    color = stat.color;
                }
                // Je≈õli jest zamkniƒôte, a status by≈Ç -1 (brak info), ustawiamy zamkniƒôte
                if(stat.type === 'closed' && statusPrio === -1) {
                    statusPrio = 0;
                    color = stat.color;
                }
            });

            let statusText = (statusPrio === 2) ? "OTWARTA" : (statusPrio === 1 ? "PRZERWA" : (statusPrio === 0 ? "ZAMKNIƒòTA" : "BRAK"));

            html += `
                <div class="station-tile" 
                     onclick="wybierzStacje('${s}')" 
                     style="border-left: 6px solid ${color};">
                    <span style="font-weight:600;">${s}</span>
                    <span class="station-status-icon" style="background:${color}; font-size:0.7rem;">${statusText}</span>
                </div>`;
        });
        
        html += '</div>';
        list.innerHTML += html;
        document.getElementById('mainStatusBox').style.display='none';
        
        // Zamknij menu je≈õli jest otwarte
        const menu = document.getElementById('settingsMenu');
        if(menu.classList.contains('active')) menu.classList.remove('active');
    }
</script>
</body>
</html>