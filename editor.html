<!DOCTYPE html>
<html lang="pl">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-W05T4L1HFD');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Edytora Danych</title>
    
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0056b3;
            --primary-dark: #004494;
            --bg-app: #f4f6f9;
            --white: #ffffff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --text-main: #333333;
            --border: #dee2e6;
            
            --row-modified: #fff3cd;
            --row-new: #d4edda;
            --row-done: #e2e6ea;
            --row-active: #cce5ff;
            --row-hidden: #e9ecef;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 50px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        .app-header {
            background: var(--white);
            padding: 10px 30px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .brand-area { display: flex; align-items: center; gap: 10px; }
        .brand-logo { font-size: 1.4rem; }
        .brand-name { font-weight: 700; font-size: 1.1rem; color: var(--primary); }
        .header-controls { display: flex; align-items: center; gap: 15px; }

        .clock-display { font-family: 'Fira Code', monospace; font-size: 0.85rem; color: #555; background: #f8f9fa; padding: 4px 8px; border-radius: 4px; border: 1px solid #e9ecef; }
        .session-timer { font-family: 'Fira Code', monospace; font-size: 0.85rem; color: #d63384; background: #fff0f6; padding: 4px 8px; border-radius: 4px; border: 1px solid #ffdeeb; cursor: pointer; }
        .session-timer:hover::after { content: " (Reset)"; font-size: 0.7em; color: #a0a0a0; }

        .global-editor-box { display: flex; align-items: center; gap: 5px; background: #e9ecef; padding: 4px 12px; border-radius: 20px; border: 1px solid #ced4da; }
        .global-editor-select { border: none; background: transparent; font-weight: 700; color: var(--primary-dark); font-size: 0.9rem; cursor: pointer; outline: none; }

        .gear-wrapper { position: relative; }
        .gear-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: #6c757d; display: flex; align-items: center; }
        .dropdown-menu { position: absolute; top: 110%; right: 0; background: var(--white); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); width: 250px; display: none; flex-direction: column; z-index: 2000; }
        .dropdown-menu.active { display: flex; }
        .menu-item { padding: 10px 15px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: var(--text-main); }
        .menu-item:hover { background: #f8f9fa; color: var(--primary); padding-left: 20px; }

        /* --- TOOLBAR --- */
        .toolbar { background: var(--white); padding: 15px 30px; border-bottom: 1px solid var(--border); display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .progress-section { flex-basis: 100%; max-width: 100%; margin-bottom: 5px; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: 600; color: #555; margin-bottom: 3px; }
        .progress-track { background: #e9ecef; height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #28a745 0%, #20c997 100%); height: 100%; width: 0%; transition: width 0.4s; }
        
        .main-controls { display: flex; gap: 10px; flex-grow: 1; align-items: center; flex-wrap: wrap; }
        .toolbar-select { padding: 8px; border-radius: 5px; border: 1px solid #ced4da; font-size: 0.95rem; max-width: 400px; }
        #filterCarrier { max-width: 200px; font-weight: 500; color: var(--primary-dark); }
        #stationSelect { flex-grow: 1; min-width: 250px; }

        .btn { padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer; border: none; font-size: 0.9rem; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid #ced4da; color: #555; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-clone { background: #e2e6ea; color: #333; }

        .carrier-link-btn { display: inline-flex; text-decoration: none; background: #e7f1ff; color: var(--primary); border: 1px solid #b8daff; padding: 8px 12px; border-radius: 5px; font-size: 0.85rem; font-weight: 600; align-items: center; gap: 5px; transition: 0.2s; height: 42px; }
        .carrier-link-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .carrier-link-btn.disabled { background: #fff5f5; color: #dc3545; border-color: #f5c6cb; text-decoration: line-through; cursor: not-allowed; pointer-events: none; opacity: 0.8; }

        /* --- FORM LAYOUT --- */
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; width: 100%; flex-grow: 1; }
        .editor-form { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 8px; border: 1px solid #dee2e6; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .card-header { font-weight: 700; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 6px; color: var(--primary); font-size: 1rem; display: flex; justify-content: space-between; align-items: center; }
        
        .col-span-12 { grid-column: span 12; }
        .col-span-6 { grid-column: span 6; }
        .col-span-3 { grid-column: span 3; }
        @media (max-width: 900px) { .col-span-3 { grid-column: span 6; } }
        @media (max-width: 600px) { .col-span-6, .col-span-3 { grid-column: span 12; } .toolbar { flex-direction: column; align-items: stretch; } }

        .form-group { margin-bottom: 12px; }
        .form-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .form-label { font-size: 0.8rem; font-weight: 700; color: #555; }
        .form-input { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.95rem; }
        .form-input.is-invalid { border-color: var(--danger); background-color: #fff8f8; }
        .error-msg { color: var(--danger); font-size: 0.75rem; font-weight: 600; display: none; margin-top: 2px; }
        .form-input.is-invalid + .error-msg { display: block; }
        textarea.form-input { resize: vertical; min-height: 50px; }

        .mini-btn { background: #fff; border: 1px solid #ced4da; border-radius: 3px; font-size: 0.7rem; padding: 2px 8px; cursor: pointer; color: #666; transition: 0.2s; font-weight: 500; }
        .mini-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        .suggestions-box { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
        .suggestion-chip { background: #f8f9fa; border: 1px solid #dee2e6; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; color: #495057; cursor: pointer; transition: 0.2s; }
        .suggestion-chip:hover { background: #e2e6ea; color: var(--primary); border-color: #ced4da; }

        /* --- TIME BUILDER STYLES --- */
        .time-editor-wrapper { background: #fff; }
        .mode-buttons { display: flex; gap: 4px; margin-bottom: 8px; }
        .mode-btn { flex: 1; padding: 5px; font-size: 0.7rem; border: 1px solid #dee2e6; background: #f8f9fa; cursor: pointer; border-radius: 4px; color: #555; font-weight: 600; text-align: center; }
        .mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .mode-btn[data-mode="closed"].active { background: #6c757d; border-color: #6c757d; }
        .mode-btn[data-mode="24h"].active { background: #17a2b8; border-color: #17a2b8; }
        .mode-btn[data-mode="custom"].active { background: var(--success); border-color: var(--success); }

        .time-rows-container { display: flex; flex-direction: column; gap: 6px; }
        .time-row { display: flex; align-items: center; gap: 5px; }
        .time-input { padding: 5px; border: 1px solid #ced4da; border-radius: 3px; font-size: 0.85rem; font-family: 'Fira Code', monospace; flex: 1; }
        .time-separator { color: #888; font-weight: bold; }
        .remove-row-btn { background: #fff0f0; border: 1px solid #ffccd5; color: var(--danger); width: 26px; height: 26px; border-radius: 3px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .remove-row-btn:hover { background: var(--danger); color: white; }
        .add-row-btn { width: 100%; padding: 4px; background: #f8f9fa; border: 1px dashed #ced4da; margin-top: 6px; color: #666; font-size: 0.75rem; cursor: pointer; border-radius: 3px; }
        .add-row-btn:hover { background: #e9ecef; color: var(--primary); border-color: var(--primary); }
        .hidden { display: none; }

        /* --- VISUALIZATION STYLES --- */
        .timeline-wrapper { margin-top: 5px; display: flex; flex-direction: column; gap: 10px; }
        .timeline-row { display: flex; align-items: center; font-size: 0.8rem; color: #555; }
        .timeline-label { width: 50px; font-weight: bold; flex-shrink: 0; }
        .timeline-track { flex-grow: 1; height: 16px; background: #e9ecef; border-radius: 3px; position: relative; overflow: hidden; border: 1px solid #dee2e6; }
        .timeline-ruler { position: absolute; width: 100%; height: 100%; top: 0; left: 0; display: flex; justify-content: space-between; pointer-events: none; padding: 0 2px; }
        .ruler-mark { height: 100%; border-left: 1px solid rgba(0,0,0,0.1); font-size: 0.6rem; color: #999; padding-left: 2px; line-height: 16px; }
        
        /* Poprawione paski wizualizacji */
        .bar-open { position: absolute; height: 100%; background: #28a745; opacity: 0.7; top: 0; z-index: 1; border-radius: 2px; }
        .bar-break { position: absolute; height: 100%; background: #ffc107; opacity: 0.9; top: 0; z-index: 2; border-left: 1px solid rgba(0,0,0,0.2); border-right: 1px solid rgba(0,0,0,0.2); }

        /* --- TABLE --- */
        .table-wrap { background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; }
        .table-scroll { max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f1f3f5; padding: 10px; text-align: left; position: sticky; top: 0; font-weight: 700; border-bottom: 2px solid #dee2e6; color: #495057; }
        td { padding: 8px 10px; border-bottom: 1px solid #dee2e6; color: #333; }
        tr:hover { background: #f8f9fa; cursor: pointer; }
        .row-modified td { background: var(--row-modified); }
        .row-new td { background: var(--row-new); }
        .row-done td { background: var(--row-done); color: #6c757d; }
        .row-active td { background: var(--row-active) !important; color: #000; }
        .row-hidden td { opacity: 0.5; background: var(--row-hidden); font-style: italic; }

        /* --- FOOTER & MODALS --- */
        .footer { text-align: center; padding: 20px; font-size: 0.85rem; color: #666; margin-top: auto; border-top: 1px solid #dee2e6; background: white; }
        #offlineAlert { display: none; background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        #toast { position: fixed; bottom: 20px; right: 20px; background: #343a40; color: white; padding: 12px 25px; border-radius: 5px; transform: translateY(150%); transition: 0.3s; z-index: 5000; }
        #toast.show { transform: translateY(0); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; display: flex; flex-direction: column; }
        .modal-large { max-width: 800px; width: 95%; }
        .code-preview-box { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 6px; font-family: 'Fira Code', monospace; max-height: 400px; overflow: auto; margin: 10px 0; }
        .key { color: #9cdcfe; } .string { color: #ce9178; } .number { color: #b5cea8; } .boolean { color: #569cd6; } .null { color: #569cd6; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; background: none; border: none; color: #999; }
        
        .help-list { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; line-height: 1.6; }
        .help-list li { margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .help-list strong { color: var(--primary); display: block; margin-bottom: 4px; font-size: 1rem; }
        .help-warn { color: #d63384; font-weight: bold; }
        
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; margin-top: 10px; padding: 8px; border: 1px dashed #ced4da; border-radius: 5px; background: #fdfdfd; }
        .checkbox-wrapper input { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-wrapper label { cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #555; }
    </style>
</head>
<body>

<header class="app-header">
    <div class="brand-area"><span class="brand-logo">üöÑ</span><span class="brand-name">Panel Edytora Danych</span></div>
    <div class="header-controls">
        <div class="clock-display" id="clockDisplay">--.--.---- --:--</div>
        <div class="session-timer" id="sessionTimer" onclick="resetSessionTimer()">Czas pracy: 00:00:00</div>
        <div class="global-editor-box">
            <span>üë§</span>
            <select id="globalEditor" class="global-editor-select" onchange="updateGlobalEditor()">
                <option value="PIOTR M">PIOTR M</option><option value="PIOTR S">PIOTR S</option><option value="ANNA S">ANNA S</option>
            </select>
        </div>
        <div class="gear-wrapper">
            <button class="gear-btn" onclick="toggleMenu()">‚öôÔ∏è</button>
            <div class="dropdown-menu" id="gearMenu">
                <div class="menu-item" onclick="downloadJSON()">‚¨áÔ∏è Pobierz JSON</div>
                <div class="menu-item" onclick="showCodePreview()">üëÅÔ∏è PodglƒÖd Kodu</div>
                <div class="menu-item" onclick="openProgressModal()">üìä Skonfiguruj Postƒôp</div>
                <div class="menu-item" onclick="openFindReplaceModal()">üîé Znajd≈∫ i Zamie≈Ñ</div>
                <div class="menu-item" onclick="openHelpModal()">‚ùì Instrukcja Obs≈Çugi</div>
                <div class="menu-item" onclick="bulkFixData()">üîß Napraw Format Danych</div>
                <div class="menu-item" onclick="bulkUpdateClosed()" style="color:var(--warning);">üî® Aktualizuj "Nieczynne"</div>
            </div>
        </div>
    </div>
</header>

<div class="toolbar">
    <div class="progress-section">
        <div class="progress-labels"><span>Postƒôp prac</span><span id="progressText">0 / 0</span></div>
        <div class="progress-track"><div class="progress-fill" id="progressBar" style="width: 0%"></div></div>
    </div>
    <div class="main-controls">
        <select id="filterCarrier" class="toolbar-select" onchange="applyFilter()">
            <option value="ALL">Wszyscy przewo≈∫nicy</option>
        </select>
        <select id="stationSelect" class="toolbar-select" onchange="loadStation()">
            <option value="-1">‚åõ Wczytywanie bazy...</option>
        </select>
        <button class="btn btn-outline" onclick="createNewStation()">+ Nowa</button>
        <button class="btn btn-clone" onclick="cloneStation()" title="Sklonuj bie≈ºƒÖcƒÖ stacjƒô">üëØ Klonuj</button>
        <button class="btn btn-danger" onclick="deleteStation()">Usu≈Ñ</button>
    </div>
    <button class="btn btn-primary" onclick="saveChanges()">üíæ Zapisz Zmiany</button>
</div>

<div class="container">
    <div id="offlineAlert">
        <strong>‚ö†Ô∏è Problem z plikiem:</strong> Nie uda≈Ço siƒô automatycznie wczytaƒá `kasy.json`.<br>
        Wybierz plik rƒôcznie z dysku: <input type="file" onchange="handleFileUpload(this)">
    </div>

    <form id="editForm" onsubmit="event.preventDefault();">
        <div class="editor-form">
            <div class="card col-span-6">
                <div class="card-header">üìç Dane Stacji</div>
                <div class="form-group">
                    <label class="form-label">Nazwa Stacji</label>
                    <input type="text" id="stacja" class="form-input" required>
                </div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px;">
                    <div class="form-group">
                        <label class="form-label">Przewo≈∫nik</label>
                        <div style="display:flex; gap:10px; align-items:flex-start;">
                            <div style="flex-grow:1;">
                                <input type="text" id="przewoznik" list="przewoznicy" class="form-input" required oninput="updateCarrierBtn()">
                                <datalist id="przewoznicy">
                                    <option value="PKP INTERCITY"><option value="POLREGIO"><option value="ARRIVA RP">
                                    <option value="KOLEJE MAZOWIECKIE"><option value="KOLEJE ≈öLƒÑSKIE"><option value="KOLEJE WIELKOPOLSKIE">
                                    <option value="KOLEJE DOLNO≈öLƒÑSKIE"><option value="≈Å√ìDZKA KOLEJ AGLOMERACYJNA"><option value="PKP SKM">
                                    <option value="KOLEJE MA≈ÅOPOLSKIE"><option value="SZYBKA KOLEJ MIEJSKA W TR√ìJMIE≈öCIE"><option value="BRAK">
                                </datalist>
                            </div>
                            <a id="carrierBtn" href="#" target="_blank" class="carrier-link-btn disabled" title="Otw√≥rz stronƒô przewo≈∫nika">üîó WWW</a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Numer EPA</label>
                        <input type="text" id="epa" class="form-input">
                    </div>
                </div>
            </div>

            <div class="card col-span-6">
                <div class="card-header">‚öôÔ∏è Meta Dane</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="form-group">
                        <label class="form-label">Edytor</label>
                        <input type="text" id="meta.kto" class="form-input" readonly style="background:#e9ecef; font-weight:bold; color:var(--primary);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data Aktualizacji</label>
                        <input type="date" id="meta.data" class="form-input" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Uwagi</label>
                    <textarea id="uwagi" class="form-input" placeholder="Wpisz uwagi..."></textarea>
                    
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="ukryty">
                        <label for="ukryty">üëÅÔ∏è Ukryj tƒô stacjƒô w podglƒÖdzie (zamiast usuwaƒá)</label>
                    </div>

                    <div class="suggestions-box">
                        <div class="suggestion-chip" onclick="insertSuggestion('PROSZƒò WERYFIKOWAƒÜ NA STRONIE PRZEWO≈πNIKA')">PROSZƒò WERYFIKOWAƒÜ...</div>
                        <div class="suggestion-chip" onclick="insertSuggestion('CENTRUM OBS≈ÅUGI KLIENTA')">CENTRUM OBS≈ÅUGI KLIENTA</div>
                        <div class="suggestion-chip" onclick="insertSuggestion('Uwaga!! Kasa nieczynna do odwo≈Çania z powodu awarii.')">Awaria / Do odwo≈Çania</div>
                    </div>
                </div>
            </div>

            <div class="card col-span-3">
                <div class="card-header">üïí Godziny</div>
                <div class="form-group">
                    <label class="form-label">Pn-Pt</label>
                    <div id="godziny.pn_pt" class="time-editor-wrapper"></div>
                </div>
                <div class="form-group">
                    <div class="form-label-row">
                        <label class="form-label">Sobota</label>
                        <button type="button" class="mini-btn" onclick="copyTime('godziny.pn_pt', 'godziny.sob')">üìã Kopiuj z Pn-Pt</button>
                    </div>
                    <div id="godziny.sob" class="time-editor-wrapper"></div>
                </div>
                <div class="form-group">
                    <div class="form-label-row">
                        <label class="form-label">Niedziela</label>
                        <div style="display:flex; gap:5px;">
                            <button type="button" class="mini-btn" onclick="copyTime('godziny.pn_pt', 'godziny.nd')">üìã z Pn-Pt</button>
                            <button type="button" class="mini-btn" onclick="copyTime('godziny.sob', 'godziny.nd')">üìã z Sob</button>
                        </div>
                    </div>
                    <div id="godziny.nd" class="time-editor-wrapper"></div>
                </div>
            </div>

            <div class="card col-span-3">
                <div class="card-header">‚òï Przerwy</div>
                <div class="form-group">
                    <label class="form-label">Pn-Pt</label>
                    <div id="przerwy.pn_pt" class="time-editor-wrapper"></div>
                </div>
                <div class="form-group">
                    <div class="form-label-row">
                        <label class="form-label">Sobota</label>
                        <button type="button" class="mini-btn" onclick="copyTime('przerwy.pn_pt', 'przerwy.sob')">üìã Kopiuj z Pn-Pt</button>
                    </div>
                    <div id="przerwy.sob" class="time-editor-wrapper"></div>
                </div>
                <div class="form-group">
                    <div class="form-label-row">
                        <label class="form-label">Niedziela</label>
                        <div style="display:flex; gap:5px;">
                            <button type="button" class="mini-btn" onclick="copyTime('przerwy.pn_pt', 'przerwy.nd')">üìã z Pn-Pt</button>
                            <button type="button" class="mini-btn" onclick="copyTime('przerwy.sob', 'przerwy.nd')">üìã z Sob</button>
                        </div>
                    </div>
                    <div id="przerwy.nd" class="time-editor-wrapper"></div>
                </div>
            </div>

            <div class="card col-span-12">
                <div class="card-header">üìä Wizualizacja dostƒôpno≈õci</div>
                <div class="timeline-wrapper">
                    <div class="timeline-row"><div class="timeline-label">Pn-Pt</div><div class="timeline-track" id="vis-pn-pt"><div class="timeline-ruler"><span class="ruler-mark">00</span><span class="ruler-mark">06</span><span class="ruler-mark">12</span><span class="ruler-mark">18</span><span class="ruler-mark">24</span></div></div></div>
                    <div class="timeline-row"><div class="timeline-label">Sobota</div><div class="timeline-track" id="vis-sob"><div class="timeline-ruler"><span class="ruler-mark">00</span><span class="ruler-mark">06</span><span class="ruler-mark">12</span><span class="ruler-mark">18</span><span class="ruler-mark">24</span></div></div></div>
                    <div class="timeline-row"><div class="timeline-label">Nd</div><div class="timeline-track" id="vis-nd"><div class="timeline-ruler"><span class="ruler-mark">00</span><span class="ruler-mark">06</span><span class="ruler-mark">12</span><span class="ruler-mark">18</span><span class="ruler-mark">24</span></div></div></div>
                </div>
                <div style="margin-top:10px; font-size:0.75rem; color:#666; display:flex; gap:15px;">
                    <span style="display:flex;align-items:center;gap:5px;"><div style="width:12px;height:12px;background:#28a745;"></div> Otwarte</span>
                    <span style="display:flex;align-items:center;gap:5px;"><div style="width:12px;height:12px;background:#ffc107;"></div> Przerwa</span>
                    <span style="display:flex;align-items:center;gap:5px;"><div style="width:12px;height:12px;background:#e9ecef;border:1px solid #ccc;"></div> Zamkniƒôte</span>
                </div>
            </div>

        </div>
    </form>

    <div class="table-wrap">
        <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #dee2e6; font-weight:700; color:#555;">üìä PodglƒÖd Bazy Danych</div>
        <div class="table-scroll">
            <table>
                <thead><tr><th>#</th><th>Stacja</th><th>Przewo≈∫nik</th><th>Uwagi</th><th>Edytor</th><th>Data</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<footer class="footer"><p>Projekt i wykonanie: <strong>Piotr M üöÇ</strong> & Gemini (AI)</p></footer>

<div class="modal-overlay" id="codeModal"><div class="modal modal-large"><button class="close-modal" onclick="closeModals()">&times;</button><div style="display:flex; justify-content:space-between; align-items:center;"><h3>üëÅÔ∏è PodglƒÖd JSON</h3><button class="btn btn-primary" onclick="copyCodeToClipboard()">üìã Kopiuj</button></div><pre class="code-preview-box"><code id="jsonPreview"></code></pre><button class="btn btn-outline" onclick="closeModals()" style="align-self: flex-end;">Zamknij</button></div></div>
<div class="modal-overlay" id="progressModal"><div class="modal"><button class="close-modal" onclick="closeModals()">&times;</button><h3>üìä Ustawienia Postƒôpu</h3><div class="form-group"><label class="form-label">Opcja A: Rƒôcznie</label><input type="number" id="manualOffset" class="form-input" value="0"></div><hr style="margin:15px 0;"><div class="form-group"><label class="form-label">Opcja B: Wg daty</label><div style="display:flex; gap:10px;"><input type="date" id="dateOffset" class="form-input"><button class="btn btn-outline" onclick="calcProgressByDate()">Oznacz</button></div></div><button class="btn btn-primary" onclick="saveProgressSettings()" style="width:100%; margin-top:15px;">Zapisz</button></div></div>
<div class="modal-overlay" id="findReplaceModal"><div class="modal"><button class="close-modal" onclick="closeModals()">&times;</button><h3>üîé Znajd≈∫ i Zamie≈Ñ</h3><p style="font-size:0.85rem; color:#666;">Ta operacja zmieni dane we wszystkich rekordach. BƒÖd≈∫ ostro≈ºny!</p><div class="form-group"><label class="form-label">Gdzie szukaƒá?</label><select id="fr_field" class="form-input"><option value="przewoznik">Przewo≈∫nik</option><option value="stacja">Nazwa Stacji</option><option value="uwagi">Uwagi</option></select></div><div class="form-group"><label class="form-label">Znajd≈∫ (tekst):</label><input type="text" id="fr_find" class="form-input" placeholder="np. Przewozy Regionalne"></div><div class="form-group"><label class="form-label">Zamie≈Ñ na:</label><input type="text" id="fr_replace" class="form-input" placeholder="np. POLREGIO"></div><div style="display:flex; gap:10px; margin-top:15px;"><button class="btn btn-primary" onclick="applyFindReplace()" style="flex:1;">Wykonaj</button><button class="btn btn-outline" onclick="closeModals()">Anuluj</button></div></div></div>

<div class="modal-overlay" id="helpModal">
    <div class="modal modal-large">
        <button class="close-modal" onclick="closeModals()">&times;</button>
        <h3>‚ùì Instrukcja Obs≈Çugi i Bezpiecze≈Ñstwo</h3>
        <div style="overflow-y:auto; max-height:400px; padding-right:10px;">
            <ul class="help-list">
                <li><strong>1. Klonowanie Stacji (üëØ Klonuj)</strong> U≈ºyj tej funkcji, gdy dodajesz stacjƒô o podobnych godzinach co poprzednia. EPA zostanie zachowane, a przewo≈∫nik wyczyszczony.</li>
                <li><strong>2. Masowa Zamiana (üîé Znajd≈∫ i Zamie≈Ñ)</strong> U≈ºyj, gdy chcesz zmieniƒá nazwƒô przewo≈∫nika lub fragment uwag w ca≈Çej bazie naraz. <span class="help-warn">UWAGA: To dzia≈Çanie jest nieodwracalne!</span></li>
                <li><strong>3. Ukrywanie Rekord√≥w (üëÅÔ∏è Ukryj)</strong> Zamiast usuwaƒá stacjƒô, zaznacz opcjƒô "Ukryj stacjƒô". Stacja pozostanie w bazie, ale nie bƒôdzie widoczna dla pasa≈ºer√≥w.</li>
                <li><strong>4. Naprawa Danych (üîß Napraw Format)</strong> Zamienia kropki w godzinach na dwukropki, usuwa zbƒôdne spacje i ujednolica numery EPA.</li>
                <li><strong>5. Bezpiecze≈Ñstwo Danych</strong> Regularnie pobieraj plik `kasy.json` jako kopiƒô zapasowƒÖ.</li>
            </ul>
        </div>
        <button class="btn btn-outline" onclick="closeModals()" style="align-self: flex-end; margin-top:15px;">Zamknij</button>
    </div>
</div>

<div id="toast">Komunikat</div>

<script>
    let database = [];
    let currentIndex = -1;
    let manualProgressOffset = 0;
    let progressRefDate = null;

    const carrierLinks = {
        "PKP INTERCITY": "https://www.intercity.pl/pl/site/dla-pasazera/kup-bilet/wyszukiwarka-kas-i-biletomatow.html",
        "POLREGIO": "https://polregio.pl/pl/dla-podroznych/gdzie-kupic-bilet/kasy-biletowe/",
        "ARRIVA RP": "https://arriva.pl/1032/kasy-biletowe",
        "KOLEJE ≈öLƒÑSKIE": "https://www.kolejeslaskie.com/kup_bilet/na-dworcu/",
        "KOLEJE MAZOWIECKIE": "https://www.mazowieckie.com.pl/pl/strefa-podroznych/wyszukiwarka-kas-biletomatow",
        "≈Å√ìDZKA KOLEJ AGLOMERACYJNA": "https://lka.lodzkie.pl/kasy-biletowe/",
        "KOLEJE WIELKOPOLSKIE": "https://koleje-wielkopolskie.com.pl/dla-pasazera/kasy-biletowe/",
        "KOLEJE DOLNO≈öLƒÑSKIE": "https://kolejedolnoslaskie.pl/informacje-o-kanalach-sprzedazy/kasy-biletowe/",
        "KOLEJE MA≈ÅOPOLSKIE": "https://www.kolejemalopolskie.com.pl/pl/dla-pasazera/gdzie-kupic-bilet-kolejowy",
        "SZYBKA KOLEJ MIEJSKA W TR√ìJMIE≈öCIE": "https://www.skm.pkp.pl/dla-pasazera/taryfy-i-przepisy/wykaz-kas-i-automatow",
        "BRAK": null
    };

    const isBreakField = (id) => id.includes('przerwy');
    
    // Normalizacja do inputa (np. "8:00" -> "08:00")
    function normalizeTimeForInput(t) { 
        if(!t) return ''; 
        t = t.trim().replace('.', ':'); 
        const p = t.split(':'); 
        return p.length===2 ? `${p[0].padStart(2,'0')}:${p[1].padStart(2,'0')}` : ''; 
    }

    function renderTimeEditor(containerId, valueString) {
        const container = document.getElementById(containerId); container.innerHTML = '';
        const isBreak = isBreakField(containerId); let cleanVal = (valueString || '').trim().replace(/‚Äì/g, '-');
        let mode = 'custom'; const valLower = cleanVal.toLowerCase();
        if (valLower.includes('zamkniƒôte') || valLower.includes('nieczynne') || valLower.includes('brak')) mode = 'closed';
        else if (valLower.includes('ca≈Çodobowo')) mode = '24h';
        else if (cleanVal === '' && isBreak) mode = 'closed';

        const btnGroup = document.createElement('div'); btnGroup.className = 'mode-buttons';
        const createBtn = (label, mName) => {
            const btn = document.createElement('div'); btn.className = `mode-btn ${mode === mName ? 'active' : ''}`; btn.innerText = label; btn.dataset.mode = mName;
            btn.onclick = () => {
                btnGroup.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
                const rc = container.querySelector('.time-rows-container'); const ab = container.querySelector('.add-row-btn');
                if (mName === 'custom') { rc.classList.remove('hidden'); ab.classList.remove('hidden'); if(rc.children.length === 0) addTimeRow(rc); }
                else { rc.classList.add('hidden'); ab.classList.add('hidden'); }
                updateTimeline(); 
            }; return btn;
        };
        btnGroup.appendChild(createBtn(isBreak ? 'Brak' : 'Zamkniƒôte', 'closed'));
        if(!isBreak) btnGroup.appendChild(createBtn('Ca≈Çodobowo', '24h'));
        btnGroup.appendChild(createBtn(isBreak ? 'Przerwa' : 'Godziny', 'custom'));
        container.appendChild(btnGroup);

        const rowsContainer = document.createElement('div'); rowsContainer.className = `time-rows-container ${mode !== 'custom' ? 'hidden' : ''}`; container.appendChild(rowsContainer);
        if (mode === 'custom') { cleanVal.split(';').forEach(p => { const t = p.split('-'); if(t.length === 2) { const t1 = normalizeTimeForInput(t[0]); const t2 = normalizeTimeForInput(t[1]); if(t1 && t2) addTimeRow(rowsContainer, t1, t2); } }); if (rowsContainer.children.length === 0) addTimeRow(rowsContainer); }
        const addBtn = document.createElement('button'); addBtn.className = `add-row-btn ${mode !== 'custom' ? 'hidden' : ''}`; addBtn.innerText = '+ Dodaj kolejny przedzia≈Ç'; addBtn.onclick = () => addTimeRow(rowsContainer); container.appendChild(addBtn);
    }

    function addTimeRow(container, s = '', e = '') {
        const row = document.createElement('div'); row.className = 'time-row';
        const i1 = document.createElement('input'); i1.type = 'time'; i1.className = 'time-input'; i1.value = s; i1.oninput = updateTimeline;
        const sp = document.createElement('span'); sp.className = 'time-separator'; sp.innerText = '-';
        const i2 = document.createElement('input'); i2.type = 'time'; i2.className = 'time-input'; i2.value = e; i2.oninput = updateTimeline;
        const db = document.createElement('div'); db.className = 'remove-row-btn'; db.innerHTML = '&times;'; db.onclick = () => { row.remove(); updateTimeline(); };
        row.append(i1, sp, i2, db); container.appendChild(row);
    }

    function getTimeEditorValue(cid) {
        const c = document.getElementById(cid); const mode = c.querySelector('.mode-btn.active')?.dataset.mode || 'closed'; const isBreak = isBreakField(cid);
        if (mode === 'closed') return isBreak ? 'Brak' : 'Zamkniƒôte'; if (mode === '24h') return 'Ca≈Çodobowo';
        const rows = c.querySelectorAll('.time-row'); let p = []; rows.forEach(r => { const i = r.querySelectorAll('input'); if(i[0].value && i[1].value) p.push(`${i[0].value}-${i[1].value}`); });
        return p.length === 0 ? (isBreak ? 'Brak' : 'Zamkniƒôte') : p.join('; ');
    }
    
    function copyTime(sid, tid) { renderTimeEditor(tid, getTimeEditorValue(sid)); updateTimeline(); showToast("Skopiowano!"); }
    function insertSuggestion(t) { document.getElementById('uwagi').value = t; }

    let sessionSeconds = 0;
    function initTimer() {
        setInterval(() => { document.getElementById('clockDisplay').innerText = new Date().toLocaleString('pl-PL'); }, 1000);
        const savedTime = localStorage.getItem('editorWorkTime'); if(savedTime) sessionSeconds = parseInt(savedTime, 10);
        setInterval(() => { sessionSeconds++; localStorage.setItem('editorWorkTime', sessionSeconds);
            const h = Math.floor(sessionSeconds / 3600).toString().padStart(2, '0'); const m = Math.floor((sessionSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = (sessionSeconds % 60).toString().padStart(2, '0'); document.getElementById('sessionTimer').innerText = `Czas pracy: ${h}:${m}:${s}`; }, 1000);
    }
    function resetSessionTimer() { if(confirm("Wyzerowaƒá licznik?")) { sessionSeconds = 0; localStorage.setItem('editorWorkTime', 0); } }
    function toggleMenu() { document.getElementById('gearMenu').classList.toggle('active'); }
    document.addEventListener('click', e => { if (!document.querySelector('.gear-wrapper').contains(e.target)) document.getElementById('gearMenu').classList.remove('active'); });

    window.onload = async function() {
        initTimer(); document.getElementById('meta.data').valueAsDate = new Date(); updateGlobalEditor();
        try { const r = await fetch('kasy.json'); if(!r.ok) throw new Error(r.status); const j = await r.json(); if(!Array.isArray(j)) throw new Error("Brak tablicy"); database = j; initData(); } 
        catch(e) { console.warn(e); document.getElementById('offlineAlert').style.display = 'block'; document.getElementById('stationSelect').innerHTML = '<option>‚ö†Ô∏è Wczytaj plik rƒôcznie</option>'; }
    };

    function handleFileUpload(input) {
        const file = input.files[0]; if(!file) return; const reader = new FileReader();
        reader.onload = function(e) { try { const j = JSON.parse(e.target.result); if (!Array.isArray(j)) throw new Error("B≈ÇƒÖd formatu"); if (j.length > 0 && !j[0].hasOwnProperty('stacja')) throw new Error("Brak pola stacja"); database = j; initData(); document.getElementById('offlineAlert').style.display = 'none'; showToast("‚úÖ Plik wczytany"); } catch(err) { alert("B≈ÇƒÖd: " + err.message); } }; reader.readAsText(file);
    }

    function initData() {
        database.sort((a,b) => a.stacja.localeCompare(b.stacja)); populateCarrierFilter(); populateSelect(); renderTable();
        ['godziny.pn_pt','godziny.sob','godziny.nd','przerwy.pn_pt','przerwy.sob','przerwy.nd'].forEach(id => renderTimeEditor(id, ''));
    }

    function populateCarrierFilter() {
        const f = document.getElementById('filterCarrier'); const u = new Set(); database.forEach(i => { if(i.przewoznik) u.add(i.przewoznik); });
        const s = Array.from(u).sort(); f.innerHTML = '<option value="ALL">Wszyscy przewo≈∫nicy</option>'; s.forEach(c => { const o = document.createElement('option'); o.value = c; o.text = c; f.appendChild(o); });
    }
    function applyFilter() { populateSelect(); renderTable(); }
    function updateCarrierBtn() { const v = document.getElementById('przewoznik').value.toUpperCase(); const b = document.getElementById('carrierBtn'); const l = carrierLinks[v]; if (l) { b.href = l; b.classList.remove('disabled'); } else { b.href = "#"; b.classList.add('disabled'); } }

    function updateTimeline() {
        drawTimelineBar('vis-pn-pt', getTimeEditorValue('godziny.pn_pt'), getTimeEditorValue('przerwy.pn_pt'));
        drawTimelineBar('vis-sob', getTimeEditorValue('godziny.sob'), getTimeEditorValue('przerwy.sob'));
        drawTimelineBar('vis-nd', getTimeEditorValue('godziny.nd'), getTimeEditorValue('przerwy.nd'));
    }

    // Nowa, pancerna funkcja parsowania czasu do wizualizacji
    function timeToMinutes(t) {
        if (!t) return null;
        // Usu≈Ñ wszystko co nie jest cyfrƒÖ lub dwukropkiem
        const clean = t.replace(/[^0-9:]/g, '');
        if (!clean.includes(':')) return null;
        const [h, m] = clean.split(':').map(Number);
        if (isNaN(h) || isNaN(m)) return null;
        return h * 60 + m;
    }

    function drawTimelineBar(eid, hStr, bStr) {
        const c = document.getElementById(eid); 
        c.querySelectorAll('.bar-open, .bar-break').forEach(el => el.remove());
        
        const createBar = (s, e, type) => {
            const sm = timeToMinutes(s); 
            const em = timeToMinutes(e);
            if(sm === null || em === null) return;
            
            let d = em - sm; 
            if (d < 0) d += 1440; 
            const effEnd = (sm + d) > 1440 ? 1440 : (sm + d);
            
            const w = ((effEnd - sm) / 1440) * 100; 
            const l = (sm / 1440) * 100;
            
            const div = document.createElement('div'); 
            div.className = type === 'open' ? 'bar-open' : 'bar-break'; 
            div.style.left = l + '%'; 
            div.style.width = w + '%'; 
            c.appendChild(div);
        };

        if(hStr.toLowerCase().includes('ca≈Çodobowo')) createBar("00:00", "24:00", 'open');
        else hStr.split(';').forEach(r => { 
            const p = r.trim().split('-'); 
            if(p.length === 2) createBar(p[0], p[1], 'open'); 
        });
        
        bStr.split(';').forEach(r => { 
            const p = r.trim().split('-'); 
            if(p.length === 2) createBar(p[0], p[1], 'break'); 
        });
    }

    function loadStation() {
        const idx = document.getElementById('stationSelect').value; currentIndex = idx; renderTable();
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        const tf = ['godziny.pn_pt','godziny.sob','godziny.nd','przerwy.pn_pt','przerwy.sob','przerwy.nd'];
        if(idx == -1) { document.getElementById('editForm').reset(); updateCarrierBtn(); tf.forEach(id => renderTimeEditor(id, '')); updateTimeline(); return; }
        const item = database[idx]; const g = k => item[k] || '';
        setValue('stacja', g('stacja')); setValue('epa', g('epa')); setValue('przewoznik', g('przewoznik')); setValue('uwagi', g('uwagi'));
        document.getElementById('ukryty').checked = item.ukryty === true;
        tf.forEach(id => renderTimeEditor(id, g(id)));
        document.getElementById('meta.kto').value = document.getElementById('globalEditor').value; document.getElementById('meta.data').valueAsDate = new Date();
        setTimeout(() => { updateCarrierBtn(); updateTimeline(); }, 0);
    }

    function saveChanges() {
        if(database.length === 0) return; const stacja = getValue('stacja'); if(!stacja) { alert("Nazwa stacji wymagana"); return; }
        const editor = document.getElementById('globalEditor').value;
        const newItem = {
            "stacja": stacja.toUpperCase(), "epa": String(getValue('epa') || "Brak"), "przewoznik": getValue('przewoznik').toUpperCase(),
            "godziny.pn_pt": getTimeEditorValue('godziny.pn_pt'), "godziny.sob": getTimeEditorValue('godziny.sob'), "godziny.nd": getTimeEditorValue('godziny.nd'),
            "przerwy.pn_pt": getTimeEditorValue('przerwy.pn_pt'), "przerwy.sob": getTimeEditorValue('przerwy.sob'), "przerwy.nd": getTimeEditorValue('przerwy.nd'),
            "uwagi": getValue('uwagi'), "ukryty": document.getElementById('ukryty').checked, "meta.kto": editor, "meta.data": getValue('meta.data')
        };
        if(currentIndex === -1) { newItem._status = 'new'; database.push(newItem); showToast("‚ú® Dodano"); }
        else { const old = database[currentIndex]._status; newItem._status = (old === 'new') ? 'new' : 'modified'; database[currentIndex] = newItem; showToast("üíæ Zapisano"); }
        database.sort((a,b) => a.stacja.localeCompare(b.stacja)); currentIndex = database.findIndex(x => x === newItem);
        populateCarrierFilter(); populateSelect(); document.getElementById('stationSelect').value = currentIndex; renderTable(); updateProgressBar();
    }
    
    function cloneStation() {
        if (currentIndex === -1) { alert("Wybierz stacjƒô do sklonowania!"); return; }
        const newItem = JSON.parse(JSON.stringify(database[currentIndex]));
        newItem.przewoznik = ""; 
        newItem.uwagi = "";      
        newItem._status = 'new';
        newItem['meta.kto'] = document.getElementById('globalEditor').value;
        newItem['meta.data'] = new Date().toISOString().split('T')[0];
        
        database.push(newItem);
        database.sort((a,b) => a.stacja.localeCompare(b.stacja));
        currentIndex = database.indexOf(newItem);
        populateSelect(); document.getElementById('stationSelect').value = currentIndex; loadStation(); renderTable(); updateProgressBar(); showToast("üëØ Sklonowano (EPA zachowane)!");
    }

    function openFindReplaceModal() { document.getElementById('gearMenu').classList.remove('active'); document.getElementById('findReplaceModal').style.display = 'flex'; }
    function applyFindReplace() {
        const f = document.getElementById('fr_field').value; const ft = document.getElementById('fr_find').value; const rt = document.getElementById('fr_replace').value;
        if(!ft) { alert("Wpisz tekst"); return; }
        if(!confirm(`Zamieniƒá "${ft}" na "${rt}" w polu [${f}]?`)) return;
        let c = 0; const ed = document.getElementById('globalEditor').value; const td = new Date().toISOString().split('T')[0];
        database.forEach(i => { if(i[f] && i[f].includes(ft)) { i[f] = i[f].replace(new RegExp(ft, 'g'), rt); i['meta.kto'] = ed; i['meta.data'] = td; i._status = 'modified'; c++; } });
        closeModals(); renderTable(); updateProgressBar(); populateCarrierFilter(); alert(`‚úÖ Zmieniono ${c} rekord√≥w.`);
    }

    function populateSelect() {
        const s = document.getElementById('stationSelect'); const fv = document.getElementById('filterCarrier').value; const old = s.value;
        s.innerHTML = '<option value="-1">-- Wybierz stacjƒô --</option>';
        database.forEach((item, i) => {
            if (fv !== 'ALL' && item.przewoznik !== fv) return;
            let t = item.stacja; if(item._status === 'modified') t += ' (üìù)'; if(item._status === 'new') t += ' (‚ú®)'; if(item.ukryty) t += ' (üëÅÔ∏è)'; if(progressRefDate && item['meta.data'] === progressRefDate) t += ' (‚úî)';
            const o = document.createElement('option'); o.value = i; o.text = t; s.appendChild(o);
        });
        if(old && old != -1) { if (s.querySelector(`option[value="${old}"]`)) s.value = old; }
    }
    
    function calcProgressByDate() { const d = document.getElementById('dateOffset').value; if(!d) return; let c = 0; progressRefDate = d; database.forEach(i => { if(i['meta.data'] === d) c++; }); document.getElementById('manualOffset').value = c; alert(`Znaleziono: ${c}`); populateSelect(); renderTable(); }
    function saveProgressSettings() { manualProgressOffset = parseInt(document.getElementById('manualOffset').value) || 0; updateProgressBar(); closeModals(); }
    function renderTable() {
        const tb = document.getElementById('tableBody'); tb.innerHTML = ''; const fv = document.getElementById('filterCarrier').value;
        database.forEach((item, i) => {
            if (fv !== 'ALL' && item.przewoznik !== fv) return;
            const tr = document.createElement('tr');
            if(item._status === 'modified') tr.className = 'row-modified'; else if(item._status === 'new') tr.className = 'row-new'; else if(progressRefDate && item['meta.data'] === progressRefDate) tr.className = 'row-done';
            if (item.ukryty) tr.classList.add('row-hidden');
            if(i == currentIndex) tr.classList.add('row-active');
            tr.onclick = () => { 
                const s = document.getElementById('stationSelect');
                if(!s.querySelector(`option[value="${i}"]`)) { const o = document.createElement('option'); o.value = i; o.text = item.stacja; o.selected = true; s.appendChild(o); }
                s.value = i; loadStation(); 
            };
            const sh = t => t && t.length > 20 ? t.substring(0,17)+'...' : (t||'');
            tr.innerHTML = `<td>${i+1}</td><td><b>${item.stacja}</b></td><td>${item.przewoznik}</td><td>${sh(item.uwagi)}</td><td>${item['meta.kto']||'-'}</td><td>${item['meta.data']}</td>`;
            tb.appendChild(tr);
        });
    }

    function updateGlobalEditor() { const g = document.getElementById('globalEditor').value; const f = document.getElementById('meta.kto'); if(f) f.value = g; }
    function getValue(id) { return document.getElementById(id).value.trim(); }
    function setValue(id, val) { document.getElementById(id).value = val; }
    function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    function createNewStation() { document.getElementById('editForm').reset(); document.getElementById('stationSelect').value = -1; currentIndex = -1; document.getElementById('meta.kto').value = document.getElementById('globalEditor').value; document.getElementById('meta.data').valueAsDate = new Date(); ['godziny.pn_pt','godziny.sob','godziny.nd','przerwy.pn_pt','przerwy.sob','przerwy.nd'].forEach(id => renderTimeEditor(id, '')); updateCarrierBtn(); updateTimeline(); showToast("Nowa Stacja"); }
    function deleteStation() { if(currentIndex===-1)return; if(confirm("UsunƒÖƒá?")){ database.splice(currentIndex,1); populateSelect(); createNewStation(); renderTable(); updateProgressBar(); showToast("üóëÔ∏è Usuniƒôto"); }}
    function syntaxHighlight(j) { if (typeof j != 'string') j = JSON.stringify(j, undefined, 2); j = j.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); return j.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, m => { let c = 'number'; if (/^"/.test(m)) { c = /:$/.test(m) ? 'key' : 'string'; } else if (/true|false/.test(m)) c = 'boolean'; else if (/null/.test(m)) c = 'null'; return '<span class="' + c + '">' + m + '</span>'; }); }
    function showCodePreview() { const c = database.map(i => { const {_status, ...r} = i; return r; }); document.getElementById('jsonPreview').innerHTML = syntaxHighlight(c); document.getElementById('gearMenu').classList.remove('active'); document.getElementById('codeModal').style.display = 'flex'; }
    function copyCodeToClipboard() { const c = database.map(i => { const {_status, ...r} = i; return r; }); navigator.clipboard.writeText(JSON.stringify(c, null, 2)).then(() => showToast("‚úÖ Skopiowano!")); }
    function downloadJSON() { if(database.length===0)return; const c = database.map(i => { const {_status, ...r} = i; return r; }); const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(c, null, 2)); const d = document.createElement('a'); d.setAttribute("href", s); d.setAttribute("download", "kasy.json"); d.click(); document.getElementById('gearMenu').classList.remove('active'); }
    function openProgressModal() { document.getElementById('gearMenu').classList.remove('active'); document.getElementById('progressModal').style.display = 'flex'; }
    function openHelpModal() { document.getElementById('gearMenu').classList.remove('active'); document.getElementById('helpModal').style.display = 'flex'; }
    function bulkFixData() { if(!confirm("Naprawiƒá format (EPA na string, godziny)?")) return; let c = 0; database.forEach(i => { if (i.epa && typeof i.epa !== 'string') { i.epa = String(i.epa); i._status = 'modified'; c++; } ['godziny.pn_pt','godziny.sob','godziny.nd','przerwy.pn_pt','przerwy.sob','przerwy.nd'].forEach(k => { if (i[k]) { const o = i[k]; let n = o.replace(/\./g, ':').replace(/\s*-\s*/g, '-').replace(/\s*;\s*/g, '; ').trim(); if (n !== o) { i[k] = n; i._status = 'modified'; c++; } } }); }); renderTable(); updateProgressBar(); showToast(`‚úÖ Zoptymalizowano ${c} p√≥l.`); document.getElementById('gearMenu').classList.remove('active'); }
    function bulkUpdateClosed() { document.getElementById('gearMenu').classList.remove('active'); if(!confirm("Zaktualizowaƒá nieczynne?")) return; const e = document.getElementById('globalEditor').value; const t = new Date().toISOString().split('T')[0]; let c = 0; database.forEach(i => { const h = (i['godziny.pn_pt'] || "").toLowerCase(); if(h.includes('zamkniƒôte') || h.includes('zamkniete') || h.includes('nieczynne')) { i['meta.kto'] = e; i['meta.data'] = t; i._status = 'modified'; c++; } }); renderTable(); updateProgressBar(); showToast(`‚úÖ Zaktualizowano ${c}`); }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(e => e.style.display = 'none'); }
    function updateProgressBar() { const m = database.filter(i => i._status === 'modified' || i._status === 'new').length; const tp = manualProgressOffset + m; const t = database.length; const d = Math.min(tp, t); const p = t > 0 ? (d / t) * 100 : 0; document.getElementById('progressBar').style.width = p + '%'; document.getElementById('progressText').innerText = `${d} / ${t} (Sesja: ${m})`; }
</script>

</body>
</html>