<!DOCTYPE html>
<html lang="pl">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-W05T4L1HFD');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Edytora Danych</title>
    
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0056b3;
            --primary-dark: #004494;
            --bg-app: #f4f6f9;
            --white: #ffffff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --text-main: #333333;
            --border: #dee2e6;
            
            --row-modified: #fff3cd;
            --row-new: #d4edda;
            --row-active: #cce5ff;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 50px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        .app-header {
            background: var(--white);
            padding: 12px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .brand-area { display: flex; align-items: center; gap: 15px; }
        .brand-logo { font-size: 1.6rem; }
        .brand-name { font-weight: 700; font-size: 1.2rem; color: var(--primary); }

        .header-controls { display: flex; align-items: center; gap: 20px; }

        .clock-display {
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            color: #555;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        /* Nowy styl dla licznika sesji */
        .session-timer {
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            color: #d63384; /* Wyr√≥≈ºniajƒÖcy siƒô kolor */
            background: #fff0f6;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ffdeeb;
            cursor: pointer; /* Klikniƒôcie resetuje */
        }
        .session-timer:hover::after {
            content: " (Kliknij aby wyzerowaƒá)";
            font-size: 0.7em;
            color: #a0a0a0;
        }

        /* Globalny Edytor */
        .global-editor-box {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #e9ecef;
            padding: 6px 15px;
            border-radius: 20px;
            border: 1px solid #ced4da;
        }
        .global-editor-select {
            border: none;
            background: transparent;
            font-weight: 700;
            color: var(--primary-dark);
            font-size: 0.95rem;
            cursor: pointer;
            outline: none;
        }

        /* Zƒôbatka Menu */
        .gear-wrapper { position: relative; }
        .gear-btn {
            background: none;
            border: none;
            font-size: 1.6rem;
            cursor: pointer;
            color: #6c757d;
            transition: transform 0.3s;
            display: flex; align-items: center;
        }
        .gear-btn:hover { color: var(--text-main); transform: rotate(45deg); }

        .dropdown-menu {
            position: absolute; top: 110%; right: 0;
            background: var(--white); border: 1px solid var(--border);
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            width: 280px; display: none; flex-direction: column; z-index: 2000;
        }
        .dropdown-menu.active { display: flex; }
        .menu-item {
            padding: 12px 20px; border-bottom: 1px solid #f1f1f1;
            cursor: pointer; display: flex; align-items: center; gap: 12px;
            font-size: 0.95rem; color: var(--text-main); transition: 0.2s;
        }
        .menu-item:hover { background: #f8f9fa; color: var(--primary); padding-left: 25px; }
        .menu-item:last-child { border-bottom: none; }

        /* --- TOOLBAR --- */
        .toolbar {
            background: var(--white);
            padding: 15px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 25px;
            align-items: center;
            flex-wrap: wrap;
        }

        .progress-section { flex-grow: 1; max-width: 400px; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 600; color: #555; margin-bottom: 5px; }
        .progress-track { background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #28a745 0%, #20c997 100%); height: 100%; width: 0%; transition: width 0.4s; }

        .main-controls { display: flex; gap: 10px; flex-grow: 1; align-items: center; }
        select.station-select { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #ced4da; font-size: 1rem; max-width: 500px; }

        .btn { padding: 10px 18px; border-radius: 5px; font-weight: 600; cursor: pointer; border: none; font-size: 0.95rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-outline { background: white; border: 1px solid #ced4da; color: #555; }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }

        /* --- CONTAINER --- */
        .container { max-width: 1300px; margin: 30px auto; padding: 0 20px; width: 100%; flex-grow: 1; }

        /* --- INSTRUKCJA --- */
        .instructions-panel {
            background: #ffffff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .instructions-header {
            background: #e7f1ff;
            padding: 12px 20px;
            font-weight: 700;
            color: #004085;
            cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .instructions-content { padding: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; font-size: 0.95rem; line-height: 1.6; }
        
        .rule-box h4 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .rule-list { list-style: none; padding: 0; margin: 0; }
        .rule-list li { margin-bottom: 8px; }
        
        .tag-good { color: #155724; background-color: #d4edda; padding: 2px 6px; border-radius: 4px; font-weight: bold; border: 1px solid #c3e6cb; }
        .tag-bad { color: #721c24; background-color: #f8d7da; padding: 2px 6px; border-radius: 4px; font-weight: bold; border: 1px solid #f5c6cb; }
        code { font-family: Consolas, monospace; background: #f8f9fa; padding: 2px 5px; border: 1px solid #dee2e6; border-radius: 3px; font-weight: 600; }

        /* --- FORM --- */
        .editor-form { display: grid; grid-template-columns: repeat(12, 1fr); gap: 25px; margin-bottom: 40px; }
        
        .card { background: white; border-radius: 8px; border: 1px solid #dee2e6; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .card-header { font-weight: 700; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 8px; color: var(--primary); font-size: 1.05rem; }
        
        .col-span-6 { grid-column: span 6; }
        .col-span-3 { grid-column: span 3; }
        @media (max-width: 900px) { .col-span-3 { grid-column: span 6; } }
        @media (max-width: 600px) { .col-span-6, .col-span-3 { grid-column: span 12; } .toolbar { flex-direction: column; align-items: stretch; } .instructions-content { grid-template-columns: 1fr; } }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 700; color: #555; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1rem; }
        .form-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,86,179,0.15); }
        
        .form-input.is-invalid { border-color: var(--danger); background-color: #fff8f8; }
        .error-msg { color: var(--danger); font-size: 0.8rem; font-weight: 600; display: none; margin-top: 3px; }
        .form-input.is-invalid + .error-msg { display: block; }

        /* --- TABLE --- */
        .table-wrap { background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; }
        .table-scroll { max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f1f3f5; padding: 12px; text-align: left; position: sticky; top: 0; font-weight: 700; border-bottom: 2px solid #dee2e6; }
        td { padding: 10px 12px; border-bottom: 1px solid #dee2e6; color: #333; }
        tr:hover { background: #f8f9fa; cursor: pointer; }
        
        .row-modified td { background: var(--row-modified); }
        .row-new td { background: var(--row-new); }

        /* --- FOOTER --- */
        .footer { text-align: center; padding: 30px; font-size: 0.9rem; color: #666; margin-top: auto; border-top: 1px solid #dee2e6; background: white; }
        
        /* Alerts */
        #offlineAlert { display: none; background: #fff3cd; color: #856404; padding: 15px; border: 1px solid #ffeeba; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        #toast { position: fixed; bottom: 20px; right: 20px; background: #343a40; color: white; padding: 12px 25px; border-radius: 5px; transform: translateY(150%); transition: 0.3s; z-index: 5000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #toast.show { transform: translateY(0); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        
        /* Styl dla podglƒÖdu kodu w modalu */
        .modal-large { max-width: 800px; width: 95%; }
        .code-preview-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
            margin: 10px 0;
            border: 1px solid #333;
        }

        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; background: none; border: none; color: #999; }
    </style>
</head>
<body>

<header class="app-header">
    <div class="brand-area">
        <span class="brand-logo">üöÑ</span>
        <span class="brand-name">Panel Edytora Danych</span>
    </div>

    <div class="header-controls">
        <div class="clock-display" id="clockDisplay">--.--.---- --:--</div>
        
        <div class="session-timer" id="sessionTimer" onclick="resetSessionTimer()" title="Kliknij, aby wyzerowaƒá">Czas pracy: 00:00:00</div>

        <div class="global-editor-box" title="Ten edytor bƒôdzie wpisywany automatycznie">
            <span>üë§</span>
            <select id="globalEditor" class="global-editor-select" onchange="updateGlobalEditor()">
                <option value="PIOTR M">PIOTR M</option>
                <option value="PIOTR S">PIOTR S</option>
                <option value="ANNA S">ANNA S</option>
            </select>
        </div>

        <div class="gear-wrapper">
            <button class="gear-btn" onclick="toggleMenu()">‚öôÔ∏è</button>
            <div class="dropdown-menu" id="gearMenu">
                <div class="menu-item" onclick="downloadJSON()">‚¨áÔ∏è Pobierz JSON</div>
                <div class="menu-item" onclick="showCodePreview()">üëÅÔ∏è PodglƒÖd Kodu</div>
                <div class="menu-item" onclick="openProgressModal()">üìä Skonfiguruj Postƒôp</div>
                <div class="menu-item" onclick="bulkUpdateClosed()" style="color:var(--warning);">üî® Aktualizuj "Nieczynne"</div>
            </div>
        </div>
    </div>
</header>

<div class="toolbar">
    <div class="progress-section">
        <div class="progress-labels">
            <span>Postƒôp prac</span>
            <span id="progressText">0 / 0</span>
        </div>
        <div class="progress-track">
            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
        </div>
    </div>

    <div class="main-controls">
        <select id="stationSelect" class="station-select" onchange="loadStation()">
            <option value="-1">‚åõ Wczytywanie bazy...</option>
        </select>
        <button class="btn btn-outline" onclick="createNewStation()">+ Nowa</button>
        <button class="btn btn-danger" onclick="deleteStation()">Usu≈Ñ</button>
    </div>

    <button class="btn btn-primary" onclick="saveChanges()">üíæ Zapisz Zmiany</button>
</div>

<div class="container">

    <div id="offlineAlert">
        <strong>‚ö†Ô∏è Problem z plikiem:</strong> Nie uda≈Ço siƒô automatycznie wczytaƒá `kasy.json`.<br>
        Wybierz plik rƒôcznie z dysku: <input type="file" onchange="handleFileUpload(this)">
    </div>

    <details class="instructions-panel" open>
        <summary class="instructions-header">
            <span>‚ÑπÔ∏è Instrukcja Wprowadzania Danych (Kliknij aby zwinƒÖƒá)</span>
            <span>‚ñº</span>
        </summary>
        <div class="instructions-content">
            <div class="rule-box">
                <h4>1. Formatowanie Godzin Otwarcia</h4>
                <p>To najwa≈ºniejsza czƒô≈õƒá, aby statusy dzia≈Ça≈Çy poprawnie.</p>
                <ul class="rule-list">
                    <li>Standardowy zakres: <code>GG:MM-GG:MM</code></li>
                    <li><span class="tag-good">‚úÖ Dobrze:</span> 07:00-19:00, 06:15-20:45</li>
                    <li><span class="tag-bad">‚ùå ≈πle:</span> 7-19, 07.00-19.00 (u≈ºywaj dwukropka!)</li>
                    <li>Kasa ca≈Çodobowa: Wpisz s≈Çowo <b>Ca≈Çodobowo</b>.</li>
                    <li>Kasa zamkniƒôta: Wpisz s≈Çowo <b>Zamkniƒôte</b> lub <b>Nieczynne</b>.</li>
                    <li>Przez p√≥≈Çnoc: <span class="tag-good">‚úÖ 06:00-02:00</span> (do 2 w nocy).</li>
                </ul>
            </div>
            <div class="rule-box">
                <h4>2. Formatowanie Przerw i Inne</h4>
                <ul class="rule-list">
                    <li>Brak przerwy: Wpisz s≈Çowo <b>Brak</b>.</li>
                    <li>Jedna przerwa: <code>10:00-10:15</code></li>
                    <li>Kilka przerw: Rozdzielaj ≈õrednikiem <code>;</code> <br>(np. 10:00-10:15; 14:00-14:30)</li>
                    <li><strong>Data:</strong> Format RRRR-MM-DD (np. <span class="tag-good">2025-11-27</span>).</li>
                </ul>
            </div>
        </div>
    </details>

    <form id="editForm" onsubmit="event.preventDefault();">
        <div class="editor-form">
            
            <div class="card col-span-6">
                <div class="card-header">üìç Dane Stacji</div>
                <div class="form-group">
                    <label class="form-label">Nazwa Stacji</label>
                    <input type="text" id="stacja" class="form-input" required>
                    <div class="error-msg">Nazwa jest wymagana</div>
                </div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px;">
                    <div class="form-group">
                        <label class="form-label">Przewo≈∫nik</label>
                        <input type="text" id="przewoznik" list="przewoznicy" class="form-input" required>
                        <div class="error-msg">Wybierz przewo≈∫nika</div>
                        <datalist id="przewoznicy">
                            <option value="PKP INTERCITY"><option value="POLREGIO"><option value="ARRIVA RP">
                            <option value="KOLEJE MAZOWIECKIE"><option value="KOLEJE ≈öLƒÑSKIE"><option value="KOLEJE WIELKOPOLSKIE">
                            <option value="KOLEJE DOLNO≈öLƒÑSKIE"><option value="≈Å√ìDZKA KOLEJ AGLOMERACYJNA"><option value="PKP SKM">
                            <option value="BRAK">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Numer EPA</label>
                        <input type="text" id="epa" class="form-input">
                    </div>
                </div>
            </div>

            <div class="card col-span-6">
                <div class="card-header">‚öôÔ∏è Meta Dane</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="form-group">
                        <label class="form-label">Edytor (Z globalnego)</label>
                        <input type="text" id="meta.kto" class="form-input" readonly style="background:#e9ecef; font-weight:bold; color:var(--primary);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data Aktualizacji</label>
                        <input type="date" id="meta.data" class="form-input" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Uwagi (Widoczne dla pasa≈ºera)</label>
                    <textarea id="uwagi" class="form-input" style="height:80px;" placeholder="Wpisz uwagi..."></textarea>
                </div>
            </div>

            <div class="card col-span-3">
                <div class="card-header">üïí Godziny</div>
                <div class="form-group"><label class="form-label">Pn-Pt</label><input type="text" id="godziny.pn_pt" class="form-input"><div class="error-msg">B≈ÇƒÖd formatu</div></div>
                <div class="form-group"><label class="form-label">Sobota</label><input type="text" id="godziny.sob" class="form-input"><div class="error-msg">B≈ÇƒÖd formatu</div></div>
                <div class="form-group"><label class="form-label">Niedziela</label><input type="text" id="godziny.nd" class="form-input"><div class="error-msg">B≈ÇƒÖd formatu</div></div>
            </div>

            <div class="card col-span-3">
                <div class="card-header">‚òï Przerwy</div>
                <div class="form-group"><label class="form-label">Pn-Pt</label><input type="text" id="przerwy.pn_pt" class="form-input"><div class="error-msg">B≈ÇƒÖd formatu</div></div>
                <div class="form-group"><label class="form-label">Sobota</label><input type="text" id="przerwy.sob" class="form-input"><div class="error-msg">B≈ÇƒÖd formatu</div></div>
                <div class="form-group"><label class="form-label">Niedziela</label><input type="text" id="przerwy.nd" class="form-input"><div class="error-msg">B≈ÇƒÖd formatu</div></div>
            </div>

        </div>
    </form>

    <div class="table-wrap">
        <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #dee2e6; font-weight:700; color:#555;">
            üìä PodglƒÖd Bazy Danych
        </div>
        <div class="table-scroll">
            <table>
                <thead>
                    <tr><th>#</th><th>Stacja</th><th>Przewo≈∫nik</th><th>Godziny Pn-Pt</th><th>Uwagi</th><th>Data</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

</div>

<footer class="footer">
    <p>Projekt i wykonanie: <strong>Piotr M üöÇ</strong> & Gemini (AI)</p>
</footer>

<div class="modal-overlay" id="codeModal">
    <div class="modal modal-large">
        <button class="close-modal" onclick="closeModals()">&times;</button>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>üëÅÔ∏è PodglƒÖd Kodu JSON</h3>
            <button class="btn btn-primary" onclick="copyCodeToClipboard()">üìã Kopiuj ca≈Çy kod</button>
        </div>
        <pre class="code-preview-box"><code id="jsonPreview"></code></pre>
        <button class="btn btn-outline" onclick="closeModals()" style="align-self: flex-end;">Zamknij</button>
    </div>
</div>

<div class="modal-overlay" id="progressModal">
    <div class="modal">
        <button class="close-modal" onclick="closeModals()">&times;</button>
        <h3>üìä Ustawienia Postƒôpu</h3>
        <p>Wybierz metodƒô ustalenia punktu startowego:</p>
        
        <div class="form-group">
            <label class="form-label">Opcja A: Wpisz rƒôcznie</label>
            <input type="number" id="manualOffset" class="form-input" value="0" placeholder="np. 50">
        </div>
        
        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
        
        <div class="form-group">
            <label class="form-label">Opcja B: Policz wg daty</label>
            <p style="font-size:0.85rem; color:#666; margin-top:0;">System policzy ile rekord√≥w ma tƒô datƒô i ustawi wynik.</p>
            <div style="display:flex; gap:10px;">
                <input type="date" id="dateOffset" class="form-input">
                <button class="btn btn-outline" onclick="calcProgressByDate()">Przelicz</button>
            </div>
        </div>

        <button class="btn btn-primary" onclick="saveProgressSettings()" style="width:100%; margin-top:15px;">Zapisz Konfiguracjƒô</button>
    </div>
</div>

<div id="toast">Komunikat</div>

<script>
    let database = [];
    let currentIndex = -1;
    let manualProgressOffset = 0;
    
    // --- ZEGAR I LICZNIK SESJI (NOWO≈öƒÜ) ---
    let sessionSeconds = 0;

    function initTimer() {
        // Zegar zwyk≈Çy
        setInterval(() => {
            const now = new Date();
            document.getElementById('clockDisplay').innerText = now.toLocaleString('pl-PL');
        }, 1000);

        // Licznik czasu pracy (Pamiƒôƒá trwa≈Ça)
        const savedTime = localStorage.getItem('editorWorkTime');
        if(savedTime) {
            sessionSeconds = parseInt(savedTime, 10);
        }

        setInterval(() => {
            sessionSeconds++;
            localStorage.setItem('editorWorkTime', sessionSeconds);
            
            const h = Math.floor(sessionSeconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((sessionSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = (sessionSeconds % 60).toString().padStart(2, '0');
            document.getElementById('sessionTimer').innerText = `Czas pracy: ${h}:${m}:${s}`;
        }, 1000);
    }

    function resetSessionTimer() {
        if(confirm("Czy na pewno chcesz wyzerowaƒá licznik czasu pracy?")) {
            sessionSeconds = 0;
            localStorage.setItem('editorWorkTime', 0);
        }
    }

    // MENU
    function toggleMenu() { document.getElementById('gearMenu').classList.toggle('active'); }
    document.addEventListener('click', function(e) {
        if (!document.querySelector('.gear-wrapper').contains(e.target)) {
            document.getElementById('gearMenu').classList.remove('active');
        }
    });

    // START
    window.onload = async function() {
        initTimer(); // Uruchomienie zegar√≥w
        document.getElementById('meta.data').valueAsDate = new Date();
        updateGlobalEditor();
        try {
            const res = await fetch('kasy.json');
            if(!res.ok) throw new Error("Status: " + res.status);
            const json = await res.json();
            
            if(!Array.isArray(json)) throw new Error("Plik JSON nie jest tablicƒÖ!");
            
            database = json;
            initData();
        } catch(e) {
            console.warn("B≈ÇƒÖd ≈Çadowania:", e);
            document.getElementById('offlineAlert').style.display = 'block';
            document.getElementById('stationSelect').innerHTML = '<option>‚ö†Ô∏è Wczytaj plik rƒôcznie</option>';
        }
    };

    function handleFileUpload(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if(!Array.isArray(json)) throw new Error("To nie jest poprawny plik bazy kas (brak tablicy).");
                database = json;
                initData();
                document.getElementById('offlineAlert').style.display = 'none';
                showToast("‚úÖ Plik wczytany poprawnie");
            } catch(err) { 
                alert("B≈ÇƒÖd przetwarzania pliku JSON:\n" + err.message); 
            }
        };
        reader.readAsText(file);
    }

    function initData() {
        database.sort((a,b) => a.stacja.localeCompare(b.stacja));
        populateSelect();
        renderTable();
        updateProgressBar();
    }

    // --- FUNKCJE DODATKOWE ---
    function updateGlobalEditor() {
        const globalVal = document.getElementById('globalEditor').value;
        const currentField = document.getElementById('meta.kto');
        if(currentField) currentField.value = globalVal;
    }

    function showCodePreview() {
        const clean = database.map(item => { const {_status, ...rest} = item; return rest; });
        document.getElementById('jsonPreview').innerText = JSON.stringify(clean, null, 2);
        document.getElementById('gearMenu').classList.remove('active');
        document.getElementById('codeModal').style.display = 'flex';
    }

    // Nowa funkcja kopiowania
    function copyCodeToClipboard() {
        const code = document.getElementById('jsonPreview').innerText;
        navigator.clipboard.writeText(code).then(() => {
            showToast("‚úÖ Skopiowano kod do schowka!");
        }).catch(err => {
            alert("B≈ÇƒÖd kopiowania: " + err);
        });
    }

    function downloadJSON() {
        if(database.length === 0) return;
        const clean = database.map(item => { const {_status, ...rest} = item; return rest; });
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(clean, null, 2));
        const dl = document.createElement('a');
        dl.setAttribute("href", dataStr);
        dl.setAttribute("download", "kasy.json");
        dl.click();
        document.getElementById('gearMenu').classList.remove('active');
    }

    function openProgressModal() {
        document.getElementById('gearMenu').classList.remove('active');
        document.getElementById('progressModal').style.display = 'flex';
    }

    function calcProgressByDate() {
        const dateVal = document.getElementById('dateOffset').value;
        if(!dateVal) { alert("Wybierz datƒô!"); return; }
        let count = 0;
        database.forEach(item => { if(item['meta.data'] === dateVal) count++; });
        document.getElementById('manualOffset').value = count;
        alert(`Znaleziono ${count} rekord√≥w z datƒÖ ${dateVal}.`);
    }

    function saveProgressSettings() {
        manualProgressOffset = parseInt(document.getElementById('manualOffset').value) || 0;
        updateProgressBar();
        closeModals();
        showToast("üìä Licznik zaktualizowany");
    }

    function bulkUpdateClosed() {
        document.getElementById('gearMenu').classList.remove('active');
        if(!confirm("Zaktualizowaƒá datƒô i edytora dla WSZYSTKICH nieczynnych kas?")) return;
        const editor = document.getElementById('globalEditor').value;
        const today = new Date().toISOString().split('T')[0];
        let count = 0;
        database.forEach(item => {
            const h = (item['godziny.pn_pt'] || "").toLowerCase();
            if(h.includes('zamkniƒôte') || h.includes('zamkniete') || h.includes('nieczynne')) {
                item['meta.kto'] = editor;
                item['meta.data'] = today;
                item._status = 'modified';
                count++;
            }
        });
        renderTable();
        updateProgressBar();
        showToast(`‚úÖ Zaktualizowano ${count} rekord√≥w`);
    }

    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none'); }

    // --- STANDARDOWE FUNKCJE ---
    function updateProgressBar() {
        const sessionModified = database.filter(i => i._status === 'modified' || i._status === 'new').length;
        const totalProgress = manualProgressOffset + sessionModified;
        const total = database.length;
        const display = Math.min(totalProgress, total);
        const percent = total > 0 ? (display / total) * 100 : 0;
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').innerText = `${display} / ${total} (Sesja: ${sessionModified})`;
    }

    function validateAll() {
        let valid = true;
        const timeReg = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]-([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
        
        const check = (id) => {
            const el = document.getElementById(id);
            const val = el.value.trim().toLowerCase();
            let ok = true;
            if(val && val !== 'brak' && !['zamkniƒôte','zamkniete','nieczynne','ca≈Çodobowo'].includes(val)) {
                if(!timeReg.test(el.value.trim())) ok = false;
            }
            if(val === '') ok = true; 
            if(ok) el.classList.remove('is-invalid'); else { el.classList.add('is-invalid'); valid = false; }
        };

        const req = (id) => {
            const el = document.getElementById(id);
            if(!el.value.trim()) { el.classList.add('is-invalid'); valid = false; } else el.classList.remove('is-invalid');
        };

        req('stacja'); req('przewoznik'); req('meta.data');
        ['godziny.pn_pt','godziny.sob','godziny.nd'].forEach(check);
        return valid;
    }

    function saveChanges() {
        if(database.length === 0) return;
        if(!validateAll()) { showToast("‚ùå Popraw b≈Çƒôdy!"); return; }

        const editor = document.getElementById('globalEditor').value;
        const newItem = {
            "stacja": getValue('stacja').toUpperCase(),
            "epa": getValue('epa') || "Brak",
            "przewoznik": getValue('przewoznik').toUpperCase(),
            "godziny.pn_pt": getValue('godziny.pn_pt') || "Zamkniƒôte",
            "godziny.sob": getValue('godziny.sob') || "Zamkniƒôte",
            "godziny.nd": getValue('godziny.nd') || "Zamkniƒôte",
            "przerwy.pn_pt": getValue('przerwy.pn_pt') || "Brak",
            "przerwy.sob": getValue('przerwy.sob') || "Brak",
            "przerwy.nd": getValue('przerwy.nd') || "Brak",
            "uwagi": getValue('uwagi'),
            "meta.kto": editor,
            "meta.data": getValue('meta.data')
        };

        if(currentIndex === -1) {
            newItem._status = 'new';
            database.push(newItem);
            showToast("‚ú® Dodano");
        } else {
            const old = database[currentIndex]._status;
            newItem._status = (old === 'new') ? 'new' : 'modified';
            database[currentIndex] = newItem;
            showToast("üíæ Zapisano");
        }
        
        database.sort((a,b) => a.stacja.localeCompare(b.stacja));
        currentIndex = database.findIndex(x => x === newItem);
        populateSelect();
        document.getElementById('stationSelect').value = currentIndex;
        renderTable();
        updateProgressBar();
    }

    function populateSelect() {
        const s = document.getElementById('stationSelect');
        s.innerHTML = '<option value="-1">-- Wybierz stacjƒô --</option>';
        database.forEach((item, i) => {
            let t = item.stacja;
            if(item._status === 'modified') t += ' (üìù)';
            if(item._status === 'new') t += ' (‚ú®)';
            const op = document.createElement('option');
            op.value = i; op.text = t;
            s.appendChild(op);
        });
    }

    function loadStation() {
        const idx = document.getElementById('stationSelect').value;
        currentIndex = idx;
        renderTable();
        
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        
        if(idx == -1) { document.getElementById('editForm').reset(); return; }
        
        const item = database[idx];
        const get = k => item[k] || '';
        
        setValue('stacja', get('stacja'));
        setValue('epa', get('epa'));
        setValue('przewoznik', get('przewoznik'));
        setValue('uwagi', get('uwagi'));
        setValue('godziny.pn_pt', get('godziny.pn_pt'));
        setValue('godziny.sob', get('godziny.sob'));
        setValue('godziny.nd', get('godziny.nd'));
        setValue('przerwy.pn_pt', get('przerwy.pn_pt'));
        setValue('przerwy.sob', get('przerwy.sob'));
        setValue('przerwy.nd', get('przerwy.nd'));
        
        document.getElementById('meta.kto').value = document.getElementById('globalEditor').value;
        document.getElementById('meta.data').valueAsDate = new Date();
    }

    function renderTable() {
        const tb = document.getElementById('tableBody');
        tb.innerHTML = '';
        database.forEach((item, i) => {
            const tr = document.createElement('tr');
            if(item._status === 'modified') tr.className = 'row-modified';
            if(item._status === 'new') tr.className = 'row-new';
            if(i == currentIndex) tr.classList.add('row-active');
            
            tr.onclick = () => { document.getElementById('stationSelect').value = i; loadStation(); };
            
            const short = t => t && t.length > 20 ? t.substring(0,17)+'...' : (t||'');
            tr.innerHTML = `<td>${i+1}</td><td><b>${item.stacja}</b></td><td>${item.przewoznik}</td><td>${short(item['godziny.pn_pt'])}</td><td>${short(item.uwagi)}</td><td>${item['meta.data']}</td>`;
            tb.appendChild(tr);
        });
    }

    function createNewStation() {
        document.getElementById('editForm').reset();
        document.getElementById('stationSelect').value = -1;
        currentIndex = -1;
        document.getElementById('meta.kto').value = document.getElementById('globalEditor').value;
        document.getElementById('meta.data').valueAsDate = new Date();
        renderTable();
        showToast("Tryb: Nowa Stacja");
    }

    function deleteStation() {
        if(currentIndex === -1) return;
        if(confirm("UsunƒÖƒá?")) {
            database.splice(currentIndex, 1);
            populateSelect();
            createNewStation();
            renderTable();
            updateProgressBar();
            showToast("üóëÔ∏è Usuniƒôto");
        }
    }

    function getValue(id) { return document.getElementById(id).value.trim(); }
    function setValue(id, val) { document.getElementById(id).value = val; }
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'), 3000);
    }
</script>

</body>
</html>